<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>【深度解析】Kube Proxy如何监听Service和Endpoint以及更新策略规则 - 维修区刷紫</title>
<meta property="og:title" content="【深度解析】Kube Proxy如何监听Service和Endpoint以及更新策略规则 - 维修区刷紫"><meta name=twitter:title content="【深度解析】Kube Proxy如何监听Service和Endpoint以及更新策略规则 - 维修区刷紫"><meta name=description content="本文会探讨Kubernetes另一个核心网络组件Kube-Proxy，它承担着Service及其后端Pod对宿主机配置的影响。
一、 先聊一下三个核心API
这三个API在不同版本下的Kube-Proxy发挥着主要作用，尤其是后两者。先上几个三个资源的常用配置一步步展开。
1. Service
Service作用核心其实就是提供一个ClusterIP和域名的配置容器以及EP/EPS组织，并没有一个单独的controller进行管理，而是被endpointslice-controller所控制。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30


apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: default
  labels:
    app: my-app
  annotations:
    description: &#34;This is a demo service&#34;
spec:
  selector:
    app: my-app
    tier: backend
  type: ClusterIP
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      name: http
  ## 粘性会话，一般用于长连接并且开启ClusterIP的场景
  sessionAffinity: None
  ## Cluster和Local，默认前者，后者用于本地流量请求
  ## 例如说，在Node1的PodA请求ServiceB，只能路由到Node1的ServiceB的Pod地址，如果本地没有则无法请求，报文会被iptables drop掉
  externalTrafficPolicy: Cluster
  ## 控制NotReady的Pod是否要包含进Service，为true的话有可能导致流量损失
  publishNotReadyAddresses: false
  ipFamilyPolicy: SingleStack
  ipFamilies:
    - IPv4
  healthCheckNodePort: 30009


2. Endpoints、EndpointSlice
EndpointSlice是在k8s 1.19版本开始默认支持的，相较于Endpoints能支持更大规模部署，受限于etcd的value值大小，ep即一个Service只能部署6000个节点，
而eps理论上可以无上限，并且eps支持网络拓扑，它可以根据集群节点的资源信息，按需部署Pod数量。具体文档在这K8s文档-EndpointSlice


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42


apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  annotations:
    ## 每一次Service或Pod改动都会update这个字段
    endpoints.kubernetes.io/last-change-trigger-time: &#34;2022-08-19T03:32:20Z&#34;
  generateName: python-server-headless-
  generation: 27
  labels:
    endpointslice.kubernetes.io/managed-by: endpointslice-controller.k8s.io
    kubernetes.io/service-name: python-server-headless
    service.kubernetes.io/headless: &#34;&#34;
  name: python-server-headless-5xvm5
  namespace: net-test
  ownerReferences:
    - apiVersion: v1
      blockOwnerDeletion: true
      controller: true
      kind: Service
      name: python-server-headless
      uid: fb7d24b3-c7cb-4b1a-8bc2-7caf2cb32101
  resourceVersion: &#34;6538663&#34;
  uid: d7475629-ac4f-46bc-9aeb-479417162ec3
addressType: IPv4
endpoints:
- addresses:
  - 10.100.58.221
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: k8s-node02
  ## 控制器基本上靠着这些信息对eps进行增删改查
  targetRef:
    kind: Pod
    name: python-server-65b886d59c-nnktx
    namespace: net-test
    uid: b3cf8828-5311-44cc-b9b1-6e8165f793f4
ports:
  - name: &#34;&#34;
    port: 80
    protocol: TCP


二、Kube-Proxy的源码分析
首先我们还是需要先认识一下Kube-Proxy的整体架构：

cmd/kube-proxy/app/server.go 这是程序主入口，对宿主机的参数和启动参数进行注入

cmd/kube-proxy/app/server_linux.go 对应不同编译平台的代码，这里会继续设置部分协议栈的一些配置，如nf_conntrack、iptables等

这里就会应用到pkg/proxy中的各种 Proxy 创建器，根据不同设置有对应的代理

pkg/proxy/iptables/proxier.go
pkg/proxy/ipvs/proxier.go


pkg/util/async/bounded_frequency_runner.go 这是控制更新iptables/ipvs的核心组件，可以自定义更新的频率窗口
两个资源的同步器，被绑定在infomer的回调函数上，用来存储监听到的缓存

pkg/proxy/endpointschangetracker.go
pkg/proxy/servicechangetracker.go







下面是kube-proxy的代码主流程，没有太复杂的内容
"><meta property="og:description" content="本文会探讨Kubernetes另一个核心网络组件Kube-Proxy，它承担着Service及其后端Pod对宿主机配置的影响。
一、 先聊一下三个核心API
这三个API在不同版本下的Kube-Proxy发挥着主要作用，尤其是后两者。先上几个三个资源的常用配置一步步展开。
1. Service
Service作用核心其实就是提供一个ClusterIP和域名的配置容器以及EP/EPS组织，并没有一个单独的controller进行管理，而是被endpointslice-controller所控制。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30


apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: default
  labels:
    app: my-app
  annotations:
    description: &#34;This is a demo service&#34;
spec:
  selector:
    app: my-app
    tier: backend
  type: ClusterIP
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      name: http
  ## 粘性会话，一般用于长连接并且开启ClusterIP的场景
  sessionAffinity: None
  ## Cluster和Local，默认前者，后者用于本地流量请求
  ## 例如说，在Node1的PodA请求ServiceB，只能路由到Node1的ServiceB的Pod地址，如果本地没有则无法请求，报文会被iptables drop掉
  externalTrafficPolicy: Cluster
  ## 控制NotReady的Pod是否要包含进Service，为true的话有可能导致流量损失
  publishNotReadyAddresses: false
  ipFamilyPolicy: SingleStack
  ipFamilies:
    - IPv4
  healthCheckNodePort: 30009


2. Endpoints、EndpointSlice
EndpointSlice是在k8s 1.19版本开始默认支持的，相较于Endpoints能支持更大规模部署，受限于etcd的value值大小，ep即一个Service只能部署6000个节点，
而eps理论上可以无上限，并且eps支持网络拓扑，它可以根据集群节点的资源信息，按需部署Pod数量。具体文档在这K8s文档-EndpointSlice


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42


apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  annotations:
    ## 每一次Service或Pod改动都会update这个字段
    endpoints.kubernetes.io/last-change-trigger-time: &#34;2022-08-19T03:32:20Z&#34;
  generateName: python-server-headless-
  generation: 27
  labels:
    endpointslice.kubernetes.io/managed-by: endpointslice-controller.k8s.io
    kubernetes.io/service-name: python-server-headless
    service.kubernetes.io/headless: &#34;&#34;
  name: python-server-headless-5xvm5
  namespace: net-test
  ownerReferences:
    - apiVersion: v1
      blockOwnerDeletion: true
      controller: true
      kind: Service
      name: python-server-headless
      uid: fb7d24b3-c7cb-4b1a-8bc2-7caf2cb32101
  resourceVersion: &#34;6538663&#34;
  uid: d7475629-ac4f-46bc-9aeb-479417162ec3
addressType: IPv4
endpoints:
- addresses:
  - 10.100.58.221
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: k8s-node02
  ## 控制器基本上靠着这些信息对eps进行增删改查
  targetRef:
    kind: Pod
    name: python-server-65b886d59c-nnktx
    namespace: net-test
    uid: b3cf8828-5311-44cc-b9b1-6e8165f793f4
ports:
  - name: &#34;&#34;
    port: 80
    protocol: TCP


二、Kube-Proxy的源码分析
首先我们还是需要先认识一下Kube-Proxy的整体架构：

cmd/kube-proxy/app/server.go 这是程序主入口，对宿主机的参数和启动参数进行注入

cmd/kube-proxy/app/server_linux.go 对应不同编译平台的代码，这里会继续设置部分协议栈的一些配置，如nf_conntrack、iptables等

这里就会应用到pkg/proxy中的各种 Proxy 创建器，根据不同设置有对应的代理

pkg/proxy/iptables/proxier.go
pkg/proxy/ipvs/proxier.go


pkg/util/async/bounded_frequency_runner.go 这是控制更新iptables/ipvs的核心组件，可以自定义更新的频率窗口
两个资源的同步器，被绑定在infomer的回调函数上，用来存储监听到的缓存

pkg/proxy/endpointschangetracker.go
pkg/proxy/servicechangetracker.go







下面是kube-proxy的代码主流程，没有太复杂的内容
"><meta name=twitter:description content="本文会探讨Kubernetes另一个核心网络组件Kube-Proxy，它承担着Service及其后端Pod对宿主机配置的影响。
一、 先聊一下三个核心API
这三个API在不同版本下的Kube-Proxy发挥着主要作用，尤其是后两者。先上几个三个资源的常用配置一步步展开。
1. Service
Service作用核心其实就是提供一个ClusterIP和域名的配置容器以及EP/EPS组织，并没有一个 …"><meta name=author content="金汤力"><link rel=icon type=image/x-icon href=/images/favicon.ico><meta property="og:site_name" content="维修区刷紫"><meta property="og:url" content="/kube-proxy%E5%A6%82%E4%BD%95%E7%9B%91%E5%90%ACservice%E5%92%8Cendpoint%E4%BB%A5%E5%8F%8A%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5%E8%A7%84%E5%88%99/"><meta property="og:type" content="article"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.120.2"><script src=https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/Base64/1.3.0/base64.min.js integrity="sha512-IFxgh3q1bUsg/sL6qotMkJZTOvPyYSS6mRSSIVnJndN5j9vWcQ+oJyHkelIkRAOaKgdU1ibHJOs4HX15sPtZKw==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b5f7da576488071eb46ec9fe633fa64",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=stylesheet href=/css/style.css media=all><link rel=stylesheet href=/css/style-dark.css media="all and (prefers-color-scheme: dark)"><link rel=stylesheet href=/css/syntax.css media=all><link rel=stylesheet href=/css/custom.css media=all><script src=/js/script.js></script><script src=/js/custom.js></script><script defer src=/fontawesome/all.min.js></script></head><body><header class=site-header><nav class=site-navi><h1 class=site-title><a href=/>维修区刷紫</a></h1><ul class=site-navi-items><li class=site-navi-item-archives><a href=/archives/ title=所有文章>所有文章</a></li><li class=site-navi-item-categories><a href=/categories/ title=类别>类别</a></li><li class=site-navi-item-about><a href=/about/ title=关于我>关于我</a></li></ul></nav></header><hr class=site-header-bottom><div class=main role=main><article class=article><h1 class=article-title>【深度解析】Kube Proxy如何监听Service和Endpoint以及更新策略规则</h1><hr class=article-title-bottom><ul class=article-meta><li class=article-meta-date><time>2022-08-13</time></li><li class=article-meta-categories><a href=/categories/kubernetes/><i class="fa-solid fa-folder"></i>
Kubernetes
</a>&nbsp;</li><li class=article-meta-categories><a href=/categories/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/><i class="fa-solid fa-folder"></i>
深度解析
</a>&nbsp;</li></ul><aside class=toc><nav id=TableOfContents><ul><li><a href=#一-先聊一下三个核心api>一、 先聊一下三个核心API</a><ul><li><a href=#1-service>1. Service</a></li><li><a href=#2-endpointsendpointslice>2. Endpoints、EndpointSlice</a></li></ul></li><li><a href=#二kube-proxy的源码分析>二、Kube-Proxy的源码分析</a><ul><li><a href=#1-kube-proxy的相关配置>1. Kube-Proxy的相关配置</a></li><li><a href=#11-boundedfrequencyrunner>1.1 BoundedFrequencyRunner</a></li><li><a href=#2-kube-proxy核心proxier实现类>2. Kube-Proxy核心，Proxier实现类</a></li><li><a href=#21-informer回调方法>2.1 Informer回调方法</a></li><li><a href=#22-serviceendpointslice的变化跟踪器>2.2 Service、EndpointSlice的变化跟踪器</a></li><li><a href=#23-iptables的syncproxyrules>2.3 iptables的syncProxyRules</a></li><li><a href=#24-ipvs的syncproxyrules>2.4 ipvs的syncProxyRules</a></li></ul></li></ul></nav></aside><p>本文会探讨Kubernetes另一个核心网络组件Kube-Proxy，它承担着Service及其后端Pod对宿主机配置的影响。</p><h2 id=一-先聊一下三个核心api>一、 先聊一下三个核心API</h2><p>这三个API在不同版本下的Kube-Proxy发挥着主要作用，尤其是后两者。先上几个三个资源的常用配置一步步展开。</p><h3 id=1-service>1. Service</h3><p><code>Service</code>作用核心其实就是提供一个ClusterIP和域名的配置容器以及EP/EPS组织，并没有一个单独的controller进行管理，而是被endpointslice-controller所控制。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This is a demo service&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tier</span><span class=p>:</span><span class=w> </span><span class=l>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## 粘性会话，一般用于长连接并且开启ClusterIP的场景</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sessionAffinity</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Cluster和Local，默认前者，后者用于本地流量请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## 例如说，在Node1的PodA请求ServiceB，只能路由到Node1的ServiceB的Pod地址，如果本地没有则无法请求，报文会被iptables drop掉</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## 控制NotReady的Pod是否要包含进Service，为true的话有可能导致流量损失</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>publishNotReadyAddresses</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilyPolicy</span><span class=p>:</span><span class=w> </span><span class=l>SingleStack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>IPv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>healthCheckNodePort</span><span class=p>:</span><span class=w> </span><span class=m>30009</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-endpointsendpointslice>2. Endpoints、EndpointSlice</h3><p><code>EndpointSlice</code>是在k8s 1.19版本开始默认支持的，相较于<code>Endpoints</code>能支持更大规模部署，受限于etcd的value值大小，ep即一个Service只能部署6000个节点，
而eps理论上可以无上限，并且eps支持网络拓扑，它可以根据集群节点的资源信息，按需部署Pod数量。具体文档在这<a href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/endpoint-slices/>K8s文档-EndpointSlice</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>discovery.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>EndpointSlice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>## 每一次Service或Pod改动都会update这个字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoints.kubernetes.io/last-change-trigger-time</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-08-19T03:32:20Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>generateName</span><span class=p>:</span><span class=w> </span><span class=l>python-server-headless-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>generation</span><span class=p>:</span><span class=w> </span><span class=m>27</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpointslice.kubernetes.io/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>endpointslice-controller.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/service-name</span><span class=p>:</span><span class=w> </span><span class=l>python-server-headless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service.kubernetes.io/headless</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>python-server-headless-5xvm5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>net-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ownerReferences</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>blockOwnerDeletion</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>python-server-headless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>fb7d24b3-c7cb-4b1a-8bc2-7caf2cb32101</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6538663&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>d7475629-ac4f-46bc-9aeb-479417162ec3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>addressType</span><span class=p>:</span><span class=w> </span><span class=l>IPv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>addresses</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>10.100.58.221</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ready</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serving</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>terminating</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>k8s-node02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## 控制器基本上靠着这些信息对eps进行增删改查</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>python-server-65b886d59c-nnktx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>net-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>b3cf8828-5311-44cc-b9b1-6e8165f793f4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=二kube-proxy的源码分析>二、Kube-Proxy的源码分析</h2><p>首先我们还是需要先认识一下Kube-Proxy的整体架构：</p><ul><li>cmd/kube-proxy/app/server.go 这是程序主入口，对宿主机的参数和启动参数进行注入<ul><li>cmd/kube-proxy/app/server_linux.go 对应不同编译平台的代码，这里会继续设置部分协议栈的一些配置，如nf_conntrack、iptables等<ul><li>这里就会应用到pkg/proxy中的各种 Proxy 创建器，根据不同设置有对应的代理<ul><li>pkg/proxy/iptables/proxier.go</li><li>pkg/proxy/ipvs/proxier.go</li></ul></li><li>pkg/util/async/bounded_frequency_runner.go 这是控制更新iptables/ipvs的核心组件，可以自定义更新的频率窗口</li><li>两个资源的同步器，被绑定在infomer的回调函数上，用来存储监听到的缓存<ul><li>pkg/proxy/endpointschangetracker.go</li><li>pkg/proxy/servicechangetracker.go</li></ul></li></ul></li></ul></li></ul><p>下面是kube-proxy的代码主流程，没有太复杂的内容</p><p><img src=/images/kube-proxy.png alt=kube-proxy.png></p><h3 id=1-kube-proxy的相关配置>1. Kube-Proxy的相关配置</h3><p>config还是比较有价值的，能了解到iptables、conntrack的核心配置有哪些，常用几个选项除了Mode就是SyncPeriod相关的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>KubeProxyConfiguration</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 *  1. 设置masqueradeAll，即所有发送到Service的请求都做SNAT
</span></span></span><span class=line><span class=cl><span class=cm>	 *  2. oom_score_adj，默认值是-999，也就是在系统内存非常低的情况下，被OOMKiller的优先级最低
</span></span></span><span class=line><span class=cl><span class=cm>	 *  3. 几个比较重要的conntrack相关的系统参数
</span></span></span><span class=line><span class=cl><span class=cm>	 *      net.netfilter.nf_conntrack_tcp_timeout_established
</span></span></span><span class=line><span class=cl><span class=cm>	 *      net.netfilter.nf_conntrack_tcp_timeout_close_wait
</span></span></span><span class=line><span class=cl><span class=cm>	 *      net.netfilter.nf_conntrack_tcp_be_liberal
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nx>Linux</span> <span class=nx>KubeProxyLinuxConfiguration</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 开启一些实验性功能
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>FeatureGates</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// client-go配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ClientConnection</span> <span class=nx>componentbaseconfig</span><span class=p>.</span><span class=nx>ClientConnectionConfiguration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>HostnameOverride</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>BindAddress</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// mode specifies which proxy mode to use.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Mode</span> <span class=nx>ProxyMode</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 *  1. LocalhostNodePorts, false不允许回环地址访问NodePort，仅在iptables&amp;ipv4生效
</span></span></span><span class=line><span class=cl><span class=cm>	    2. 
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPTables</span> <span class=nx>KubeProxyIPTablesConfiguration</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ipvs contains ipvs-related configuration options.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>IPVS</span> <span class=nx>KubeProxyIPVSConfiguration</span>
</span></span><span class=line><span class=cl>	<span class=c1>// nftables contains nftables-related configuration options.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>NFTables</span> <span class=nx>KubeProxyNFTablesConfiguration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 检测本地流量的模式，默认通过ClusterCIDR
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>DetectLocalMode</span> <span class=nx>LocalMode</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 网桥名称、ClusterCIDR、设备前缀等设置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>DetectLocal</span> <span class=nx>DetectLocalConfiguration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 指定哪些CIDR访问能使用NodePort暴露端口，比如数据库或特定的服务
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>NodePortAddresses</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 下面两个参数都应用在BoundedFrequencyRunner定时器中，Kube-Proxy更新的最高频率受限于MinSyncPeriod和内部burstRuns两个参数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 这是Proxy规则同步的最大间隔
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>SyncPeriod</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 最小间隔
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>MinSyncPeriod</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	<span class=nx>ConfigSyncPeriod</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=11-boundedfrequencyrunner>1.1 BoundedFrequencyRunner</h3><p>正如名称所说，这是一个有边界频率的任务执行器，会限制runner执行的qps，无法高频更新配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewBoundedFrequencyRunner</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>fn</span> <span class=kd>func</span><span class=p>(),</span> <span class=nx>minInterval</span><span class=p>,</span> <span class=nx>maxInterval</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span> <span class=nx>burstRuns</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>BoundedFrequencyRunner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// fn: 执行方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// minInterval和burstRuns用于控制runner最高qps是多少，超过会合并至下一个interval执行。该值允许为0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// maxInterval则是最大周期，离上一次更新满足这个区间会自动tick
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>timer</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>realTimer</span><span class=p>{</span><span class=nx>timer</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=mi>0</span><span class=p>)}</span> <span class=c1>// will tick immediately
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nf>C</span><span class=p>()</span>                                  <span class=c1>// consume the first tick
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nf>construct</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>fn</span><span class=p>,</span> <span class=nx>minInterval</span><span class=p>,</span> <span class=nx>maxInterval</span><span class=p>,</span> <span class=nx>burstRuns</span><span class=p>,</span> <span class=nx>timer</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Make an instance with dependencies injected.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>construct</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>fn</span> <span class=kd>func</span><span class=p>(),</span> <span class=nx>minInterval</span><span class=p>,</span> <span class=nx>maxInterval</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span> <span class=nx>burstRuns</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>timer</span> <span class=nx>timer</span><span class=p>)</span> <span class=o>*</span><span class=nx>BoundedFrequencyRunner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// bfr := &amp;BoundedFrequencyRunner{ ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>minInterval</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>bfr</span><span class=p>.</span><span class=nx>limiter</span> <span class=p>=</span> <span class=nx>nullLimiter</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// allow burst updates in short succession
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>qps</span> <span class=o>:=</span> <span class=nb>float32</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float32</span><span class=p>(</span><span class=nx>minInterval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// flowcontrol是client-go中专门用于流量控制的工具库，提供了几种令牌实现工具
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 具体路径staging/src/k8s.io/client-go/util/flowcontrol/throttle.go
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>bfr</span><span class=p>.</span><span class=nx>limiter</span> <span class=p>=</span> <span class=nx>flowcontrol</span><span class=p>.</span><span class=nf>NewTokenBucketRateLimiterWithClock</span><span class=p>(</span><span class=nx>qps</span><span class=p>,</span> <span class=nx>burstRuns</span><span class=p>,</span> <span class=nx>timer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>bfr</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-kube-proxy核心proxier实现类>2. Kube-Proxy核心，Proxier实现类</h3><p>每个interface都有个XXXSynced()的方法，写过控制器的都知道<code>cache.WaitForNamedCacheSync()</code>，其实是为了infomer.start()后第一次拉去apiserver准备的，同步本地缓存后才执行</p><p><img src=/images/Proxier%E5%9F%BA%E7%A1%80%E5%9B%BE.png alt=Proxier继承图.png></p><h3 id=21-informer回调方法>2.1 Informer回调方法</h3><p>下面几个接口都在<code>pkg/proxy/config/config.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>NodeHandler</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ServiceHandler</span> <span class=kd>interface</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这个是Service监听回调的核心接口
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>OnServiceUpdate</span><span class=p>(</span><span class=nx>oldService</span><span class=p>,</span> <span class=nx>service</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Service</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>EndpointSliceHandler</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// 这个是监听Service ClusterIP的分配区间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ServiceCIDRHandler</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里没什么好说的，只是调用链比较隐晦，都是通过同一个go文件下<code>RegisterEventHandler</code>方法注册进来的</p><h3 id=22-serviceendpointslice的变化跟踪器>2.2 Service、EndpointSlice的变化跟踪器</h3><p><code>ServiceChangeTracker</code>唯一对外的方法就只有Update，功能就是更新成员变量<code>item</code>，并且告知调用方是否有Service更新。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 一方三用：previous空为add，current空为del，两个都有为update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>sct</span> <span class=o>*</span><span class=nx>ServiceChangeTracker</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>previous</span><span class=p>,</span> <span class=nx>current</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Service</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>previous</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>current</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>svc</span> <span class=o>:=</span> <span class=nx>current</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>svc</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>svc</span> <span class=p>=</span> <span class=nx>previous</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>ServiceChangesTotal</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>namespacedName</span> <span class=o>:=</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Namespace</span><span class=p>:</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=nx>svc</span><span class=p>.</span><span class=nx>Name</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>sct</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>sct</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>change</span><span class=p>,</span> <span class=nx>exists</span> <span class=o>:=</span> <span class=nx>sct</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>namespacedName</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>change</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>serviceChange</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 把Service声明不同端口的配置，映射成多个Service
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>change</span><span class=p>.</span><span class=nx>previous</span> <span class=p>=</span> <span class=nx>sct</span><span class=p>.</span><span class=nf>serviceToServiceMap</span><span class=p>(</span><span class=nx>previous</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>sct</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>namespacedName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>change</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>change</span><span class=p>.</span><span class=nx>current</span> <span class=p>=</span> <span class=nx>sct</span><span class=p>.</span><span class=nf>serviceToServiceMap</span><span class=p>(</span><span class=nx>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 相等意味着Service没有变化
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 不想等，一般来说就是更新了port配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>(</span><span class=nx>change</span><span class=p>.</span><span class=nx>previous</span><span class=p>,</span> <span class=nx>change</span><span class=p>.</span><span class=nx>current</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>delete</span><span class=p>(</span><span class=nx>sct</span><span class=p>.</span><span class=nx>items</span><span class=p>,</span> <span class=nx>namespacedName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Service updated ports&#34;</span><span class=p>,</span> <span class=s>&#34;service&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>svc</span><span class=p>),</span> <span class=s>&#34;portCount&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>change</span><span class=p>.</span><span class=nx>current</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>ServiceChangesPending</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>sct</span><span class=p>.</span><span class=nx>items</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>sct</span><span class=p>.</span><span class=nx>items</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>EndpointsChangeTracker</code>的数据结构明显复杂多了，但基本上围绕着<code>trackerByServiceMap</code>展开</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>ect</span> <span class=o>*</span><span class=nx>EndpointsChangeTracker</span><span class=p>)</span> <span class=nf>EndpointSliceUpdate</span><span class=p>(</span><span class=nx>endpointSlice</span> <span class=o>*</span><span class=nx>discovery</span><span class=p>.</span><span class=nx>EndpointSlice</span><span class=p>,</span> <span class=nx>removeSlice</span> <span class=kt>bool</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>namespacedName</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>endpointSliceCacheKeys</span><span class=p>(</span><span class=nx>endpointSlice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ect</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>ect</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 这里的比对现有cache的缓存，是否最新版本
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>changeNeeded</span> <span class=o>:=</span> <span class=nx>ect</span><span class=p>.</span><span class=nx>endpointSliceCache</span><span class=p>.</span><span class=nf>updatePending</span><span class=p>(</span><span class=nx>endpointSlice</span><span class=p>,</span> <span class=nx>removeSlice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>changeNeeded</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>EndpointChangesPending</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// lastChangeTriggerTime仅用于metrics:kubeproxy_network_programming_duration_seconds记录消耗时间
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 从Pod的IP地址被增删改查的时刻，到完成所有rule被同步的时长
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>removeSlice</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>delete</span><span class=p>(</span><span class=nx>ect</span><span class=p>.</span><span class=nx>lastChangeTriggerTimes</span><span class=p>,</span> <span class=nx>namespacedName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>t</span> <span class=o>:=</span> <span class=nf>getLastChangeTriggerTime</span><span class=p>(</span><span class=nx>endpointSlice</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>);</span> <span class=p>!</span><span class=nx>t</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=nx>t</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>ect</span><span class=p>.</span><span class=nx>trackerStartTime</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ect</span><span class=p>.</span><span class=nx>lastChangeTriggerTimes</span><span class=p>[</span><span class=nx>namespacedName</span><span class=p>]</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>				<span class=nb>append</span><span class=p>(</span><span class=nx>ect</span><span class=p>.</span><span class=nx>lastChangeTriggerTimes</span><span class=p>[</span><span class=nx>namespacedName</span><span class=p>],</span> <span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>changeNeeded</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>cache</span> <span class=o>*</span><span class=nx>EndpointSliceCache</span><span class=p>)</span> <span class=nf>updatePending</span><span class=p>(</span><span class=nx>endpointSlice</span> <span class=o>*</span><span class=nx>discovery</span><span class=p>.</span><span class=nx>EndpointSlice</span><span class=p>,</span> <span class=nx>remove</span> <span class=kt>bool</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>serviceKey</span><span class=p>,</span> <span class=nx>sliceKey</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>endpointSliceCacheKeys</span><span class=p>(</span><span class=nx>endpointSlice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>esData</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>endpointSliceData</span><span class=p>{</span><span class=nx>endpointSlice</span><span class=p>,</span> <span class=nx>remove</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>cache</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>trackerByServiceMap</span><span class=p>[</span><span class=nx>serviceKey</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这个是新的Service
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cache</span><span class=p>.</span><span class=nx>trackerByServiceMap</span><span class=p>[</span><span class=nx>serviceKey</span><span class=p>]</span> <span class=p>=</span> <span class=nf>newEndpointSliceTracker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里就是在比对有没有被缓存过，或者真准备被proixer应用，如果都没有则追加到pending中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 在同步的时候会做一次全量checkout到applied
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>changed</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>esDataChanged</span><span class=p>(</span><span class=nx>serviceKey</span><span class=p>,</span> <span class=nx>sliceKey</span><span class=p>,</span> <span class=nx>esData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>changed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cache</span><span class=p>.</span><span class=nx>trackerByServiceMap</span><span class=p>[</span><span class=nx>serviceKey</span><span class=p>].</span><span class=nx>pending</span><span class=p>[</span><span class=nx>sliceKey</span><span class=p>]</span> <span class=p>=</span> <span class=nx>esData</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>changed</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=23-iptables的syncproxyrules>2.3 iptables的syncProxyRules</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span><span class=lnt>518
</span><span class=lnt>519
</span><span class=lnt>520
</span><span class=lnt>521
</span><span class=lnt>522
</span><span class=lnt>523
</span><span class=lnt>524
</span><span class=lnt>525
</span><span class=lnt>526
</span><span class=lnt>527
</span><span class=lnt>528
</span><span class=lnt>529
</span><span class=lnt>530
</span><span class=lnt>531
</span><span class=lnt>532
</span><span class=lnt>533
</span><span class=lnt>534
</span><span class=lnt>535
</span><span class=lnt>536
</span><span class=lnt>537
</span><span class=lnt>538
</span><span class=lnt>539
</span><span class=lnt>540
</span><span class=lnt>541
</span><span class=lnt>542
</span><span class=lnt>543
</span><span class=lnt>544
</span><span class=lnt>545
</span><span class=lnt>546
</span><span class=lnt>547
</span><span class=lnt>548
</span><span class=lnt>549
</span><span class=lnt>550
</span><span class=lnt>551
</span><span class=lnt>552
</span><span class=lnt>553
</span><span class=lnt>554
</span><span class=lnt>555
</span><span class=lnt>556
</span><span class=lnt>557
</span><span class=lnt>558
</span><span class=lnt>559
</span><span class=lnt>560
</span><span class=lnt>561
</span><span class=lnt>562
</span><span class=lnt>563
</span><span class=lnt>564
</span><span class=lnt>565
</span><span class=lnt>566
</span><span class=lnt>567
</span><span class=lnt>568
</span><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=lnt>572
</span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=lnt>576
</span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=lnt>581
</span><span class=lnt>582
</span><span class=lnt>583
</span><span class=lnt>584
</span><span class=lnt>585
</span><span class=lnt>586
</span><span class=lnt>587
</span><span class=lnt>588
</span><span class=lnt>589
</span><span class=lnt>590
</span><span class=lnt>591
</span><span class=lnt>592
</span><span class=lnt>593
</span><span class=lnt>594
</span><span class=lnt>595
</span><span class=lnt>596
</span><span class=lnt>597
</span><span class=lnt>598
</span><span class=lnt>599
</span><span class=lnt>600
</span><span class=lnt>601
</span><span class=lnt>602
</span><span class=lnt>603
</span><span class=lnt>604
</span><span class=lnt>605
</span><span class=lnt>606
</span><span class=lnt>607
</span><span class=lnt>608
</span><span class=lnt>609
</span><span class=lnt>610
</span><span class=lnt>611
</span><span class=lnt>612
</span><span class=lnt>613
</span><span class=lnt>614
</span><span class=lnt>615
</span><span class=lnt>616
</span><span class=lnt>617
</span><span class=lnt>618
</span><span class=lnt>619
</span><span class=lnt>620
</span><span class=lnt>621
</span><span class=lnt>622
</span><span class=lnt>623
</span><span class=lnt>624
</span><span class=lnt>625
</span><span class=lnt>626
</span><span class=lnt>627
</span><span class=lnt>628
</span><span class=lnt>629
</span><span class=lnt>630
</span><span class=lnt>631
</span><span class=lnt>632
</span><span class=lnt>633
</span><span class=lnt>634
</span><span class=lnt>635
</span><span class=lnt>636
</span><span class=lnt>637
</span><span class=lnt>638
</span><span class=lnt>639
</span><span class=lnt>640
</span><span class=lnt>641
</span><span class=lnt>642
</span><span class=lnt>643
</span><span class=lnt>644
</span><span class=lnt>645
</span><span class=lnt>646
</span><span class=lnt>647
</span><span class=lnt>648
</span><span class=lnt>649
</span><span class=lnt>650
</span><span class=lnt>651
</span><span class=lnt>652
</span><span class=lnt>653
</span><span class=lnt>654
</span><span class=lnt>655
</span><span class=lnt>656
</span><span class=lnt>657
</span><span class=lnt>658
</span><span class=lnt>659
</span><span class=lnt>660
</span><span class=lnt>661
</span><span class=lnt>662
</span><span class=lnt>663
</span><span class=lnt>664
</span><span class=lnt>665
</span><span class=lnt>666
</span><span class=lnt>667
</span><span class=lnt>668
</span><span class=lnt>669
</span><span class=lnt>670
</span><span class=lnt>671
</span><span class=lnt>672
</span><span class=lnt>673
</span><span class=lnt>674
</span><span class=lnt>675
</span><span class=lnt>676
</span><span class=lnt>677
</span><span class=lnt>678
</span><span class=lnt>679
</span><span class=lnt>680
</span><span class=lnt>681
</span><span class=lnt>682
</span><span class=lnt>683
</span><span class=lnt>684
</span><span class=lnt>685
</span><span class=lnt>686
</span><span class=lnt>687
</span><span class=lnt>688
</span><span class=lnt>689
</span><span class=lnt>690
</span><span class=lnt>691
</span><span class=lnt>692
</span><span class=lnt>693
</span><span class=lnt>694
</span><span class=lnt>695
</span><span class=lnt>696
</span><span class=lnt>697
</span><span class=lnt>698
</span><span class=lnt>699
</span><span class=lnt>700
</span><span class=lnt>701
</span><span class=lnt>702
</span><span class=lnt>703
</span><span class=lnt>704
</span><span class=lnt>705
</span><span class=lnt>706
</span><span class=lnt>707
</span><span class=lnt>708
</span><span class=lnt>709
</span><span class=lnt>710
</span><span class=lnt>711
</span><span class=lnt>712
</span><span class=lnt>713
</span><span class=lnt>714
</span><span class=lnt>715
</span><span class=lnt>716
</span><span class=lnt>717
</span><span class=lnt>718
</span><span class=lnt>719
</span><span class=lnt>720
</span><span class=lnt>721
</span><span class=lnt>722
</span><span class=lnt>723
</span><span class=lnt>724
</span><span class=lnt>725
</span><span class=lnt>726
</span><span class=lnt>727
</span><span class=lnt>728
</span><span class=lnt>729
</span><span class=lnt>730
</span><span class=lnt>731
</span><span class=lnt>732
</span><span class=lnt>733
</span><span class=lnt>734
</span><span class=lnt>735
</span><span class=lnt>736
</span><span class=lnt>737
</span><span class=lnt>738
</span><span class=lnt>739
</span><span class=lnt>740
</span><span class=lnt>741
</span><span class=lnt>742
</span><span class=lnt>743
</span><span class=lnt>744
</span><span class=lnt>745
</span><span class=lnt>746
</span><span class=lnt>747
</span><span class=lnt>748
</span><span class=lnt>749
</span><span class=lnt>750
</span><span class=lnt>751
</span><span class=lnt>752
</span><span class=lnt>753
</span><span class=lnt>754
</span><span class=lnt>755
</span><span class=lnt>756
</span><span class=lnt>757
</span><span class=lnt>758
</span><span class=lnt>759
</span><span class=lnt>760
</span><span class=lnt>761
</span><span class=lnt>762
</span><span class=lnt>763
</span><span class=lnt>764
</span><span class=lnt>765
</span><span class=lnt>766
</span><span class=lnt>767
</span><span class=lnt>768
</span><span class=lnt>769
</span><span class=lnt>770
</span><span class=lnt>771
</span><span class=lnt>772
</span><span class=lnt>773
</span><span class=lnt>774
</span><span class=lnt>775
</span><span class=lnt>776
</span><span class=lnt>777
</span><span class=lnt>778
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>syncProxyRules</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The value of proxier.needFullSync may change before the defer funcs run, so
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// we need to keep track of whether it was set at the *start* of the sync.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tryPartialSync</span> <span class=o>:=</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>needFullSync</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// metrics 统计该方法的执行时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>serviceUpdateResult</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>svcPortMap</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceChanges</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpointUpdateResult</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsMap</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsChanges</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nx>success</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>success</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 失败重试 -&gt; metrics
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>tryPartialSync</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Ensure that our jump rules (eg from PREROUTING to KUBE-SERVICES) exist.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// We can&#39;t do this as part of the iptables-restore because we don&#39;t want
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// to specify/replace *all* of the rules in PREROUTING, etc.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// We need to create these rules when kube-proxy first starts, and we need
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// to recreate them if the utiliptables Monitor detects that iptables has
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// been flushed. In both of those cases, the code will force a full sync.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// In all other cases, it ought to be safe to assume that the rules
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// already exist, so we&#39;ll skip this step when doing a partial sync, to
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// save us from having to invoke /sbin/iptables 20 times on each sync
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// (which will be very slow on hosts with lots of iptables rules).
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>jump</span> <span class=o>:=</span> <span class=k>range</span> <span class=nb>append</span><span class=p>(</span><span class=nx>iptablesJumpChains</span><span class=p>,</span> <span class=nx>iptablesKubeletJumpChains</span><span class=o>...</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptables</span><span class=p>.</span><span class=nf>EnsureChain</span><span class=p>(</span><span class=nx>jump</span><span class=p>.</span><span class=nx>table</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>dstChain</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to ensure chain exists&#34;</span><span class=p>,</span> <span class=s>&#34;table&#34;</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>table</span><span class=p>,</span> <span class=s>&#34;chain&#34;</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>dstChain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>args</span> <span class=o>:=</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>extraArgs</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>comment</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>args</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>comment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>args</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>jump</span><span class=p>.</span><span class=nx>dstChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptables</span><span class=p>.</span><span class=nf>EnsureRule</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>Prepend</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>table</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>srcChain</span><span class=p>,</span> <span class=nx>args</span><span class=o>...</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to ensure chain jumps&#34;</span><span class=p>,</span> <span class=s>&#34;table&#34;</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>table</span><span class=p>,</span> <span class=s>&#34;srcChain&#34;</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>srcChain</span><span class=p>,</span> <span class=s>&#34;dstChain&#34;</span><span class=p>,</span> <span class=nx>jump</span><span class=p>.</span><span class=nx>dstChain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// ensure the nfacct counters
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nfacct</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>name</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nfAcctCounters</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nfacct</span><span class=p>.</span><span class=nf>Ensure</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>nfAcctCounters</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to create nfacct counter; the corresponding metric will not be updated&#34;</span><span class=p>,</span> <span class=s>&#34;counter&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>nfAcctCounters</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Below this point we will not return until we try to write the iptables rules.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Reset all buffers used later.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is to avoid memory reallocations and thus improve performance.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterChains</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>skippedNatChains</span> <span class=o>:=</span> <span class=nx>proxyutil</span><span class=p>.</span><span class=nf>NewDiscardLineBuffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>skippedNatRules</span> <span class=o>:=</span> <span class=nx>proxyutil</span><span class=p>.</span><span class=nf>NewDiscardLineBuffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Write chain lines for all the &#34;top-level&#34; chains we&#39;ll be filling in
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>chainName</span> <span class=o>:=</span> <span class=k>range</span> <span class=p>[]</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>Chain</span><span class=p>{</span><span class=nx>kubeServicesChain</span><span class=p>,</span> <span class=nx>kubeExternalServicesChain</span><span class=p>,</span> <span class=nx>kubeForwardChain</span><span class=p>,</span> <span class=nx>kubeNodePortsChain</span><span class=p>,</span> <span class=nx>kubeProxyFirewallChain</span><span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>chainName</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>chainName</span> <span class=o>:=</span> <span class=k>range</span> <span class=p>[]</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>Chain</span><span class=p>{</span><span class=nx>kubeServicesChain</span><span class=p>,</span> <span class=nx>kubeNodePortsChain</span><span class=p>,</span> <span class=nx>kubePostroutingChain</span><span class=p>,</span> <span class=nx>kubeMarkMasqChain</span><span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>chainName</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Install the kubernetes-specific postrouting rules. We use a whole chain for
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// this so that it is easier to flush and change, for example if the mark
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// value should ever change.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubePostroutingChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;mark&#34;</span><span class=p>,</span> <span class=s>&#34;!&#34;</span><span class=p>,</span> <span class=s>&#34;--mark&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/%s&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>masqueradeMark</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>masqueradeMark</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;RETURN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Clear the mark to avoid re-masquerading if the packet re-traverses the network stack.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubePostroutingChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;MARK&#34;</span><span class=p>,</span> <span class=s>&#34;--xor-mark&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>masqueradeMark</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>masqRule</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubePostroutingChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=s>`&#34;kubernetes service traffic requiring SNAT&#34;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;MASQUERADE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptables</span><span class=p>.</span><span class=nf>HasRandomFully</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>masqRule</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>masqRule</span><span class=p>,</span> <span class=s>&#34;--random-fully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>masqRule</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Install the kubernetes-specific masquerade mark rule. We use a whole chain for
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// this so that it is easier to flush and change, for example if the mark
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// value should ever change.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeMarkMasqChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;MARK&#34;</span><span class=p>,</span> <span class=s>&#34;--or-mark&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>masqueradeMark</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>isIPv6</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptables</span><span class=p>.</span><span class=nf>IsIPv6</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>isIPv6</span> <span class=o>&amp;&amp;</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>localhostNodePorts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Kube-proxy&#39;s use of `route_localnet` to enable NodePorts on localhost
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// creates a security hole (https://issue.k8s.io/90259) which this
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// iptables rule mitigates.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>		<span class=c1>// NOTE: kubelet creates an identical copy of this rule. If you want to
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// change this rule in the future, you MUST do so in a way that will
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// interoperate correctly with skewed versions of the rule created by
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// kubelet. (Actually, kubelet uses &#34;--dst&#34;/&#34;--src&#34; rather than &#34;-d&#34;/&#34;-s&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// but that&#39;s just a command-line thing and results in the same rule being
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// created in the kernel.)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>kubeletFirewallChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeletFirewallChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=s>`&#34;block incoming localnet connections&#34;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.0/8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;!&#34;</span><span class=p>,</span> <span class=s>&#34;-s&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.0/8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;conntrack&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;!&#34;</span><span class=p>,</span> <span class=s>&#34;--ctstate&#34;</span><span class=p>,</span> <span class=s>&#34;RELATED,ESTABLISHED,DNAT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;DROP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Accumulate NAT chains to keep.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>activeNATChains</span> <span class=o>:=</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>New</span><span class=p>[</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>Chain</span><span class=p>]()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// To avoid growing this slice, we arbitrarily set its size to 64,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// there is never more than that many arguments for a single line.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Note that even if we go over 64, it will still be correct - it
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// is just for efficiency, not correctness.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>args</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Compute total number of endpoint chains across all services
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to get a sense of how big the cluster is.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>totalEndpoints</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>svcName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>svcPortMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>totalEndpoints</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsMap</span><span class=p>[</span><span class=nx>svcName</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>largeClusterMode</span> <span class=p>=</span> <span class=p>(</span><span class=nx>totalEndpoints</span> <span class=p>&gt;</span> <span class=nx>largeClusterEndpointsThreshold</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// These two variables are used to publish the sync_proxy_rules_no_endpoints_total
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// metric.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serviceNoLocalEndpointsTotalInternal</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=nx>serviceNoLocalEndpointsTotalExternal</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Build rules for each service-port.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>svcName</span><span class=p>,</span> <span class=nx>svc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>svcPortMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>svcInfo</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>svc</span><span class=p>.(</span><span class=o>*</span><span class=nx>servicePortInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Failed to cast serviceInfo&#34;</span><span class=p>,</span> <span class=s>&#34;serviceName&#34;</span><span class=p>,</span> <span class=nx>svcName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>protocol</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>		<span class=nx>svcPortNameString</span> <span class=o>:=</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nx>nameString</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Figure out the endpoints for Cluster and Local traffic policy.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// allLocallyReachableEndpoints is the set of all endpoints that can be routed to
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// from this node, given the service&#39;s traffic policies. hasEndpoints is true
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// if the service has any usable endpoints on any node, not just this one.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>allEndpoints</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsMap</span><span class=p>[</span><span class=nx>svcName</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=nx>clusterEndpoints</span><span class=p>,</span> <span class=nx>localEndpoints</span><span class=p>,</span> <span class=nx>allLocallyReachableEndpoints</span><span class=p>,</span> <span class=nx>hasEndpoints</span> <span class=o>:=</span> <span class=nx>proxy</span><span class=p>.</span><span class=nf>CategorizeEndpoints</span><span class=p>(</span><span class=nx>allEndpoints</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nodeLabels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// clusterPolicyChain contains the endpoints used with &#34;Cluster&#34; traffic policy
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>clusterPolicyChain</span> <span class=o>:=</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nx>clusterPolicyChainName</span>
</span></span><span class=line><span class=cl>		<span class=nx>usesClusterPolicyChain</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>clusterEndpoints</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>UsesClusterEndpoints</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// localPolicyChain contains the endpoints used with &#34;Local&#34; traffic policy
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>localPolicyChain</span> <span class=o>:=</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nx>localPolicyChainName</span>
</span></span><span class=line><span class=cl>		<span class=nx>usesLocalPolicyChain</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>localEndpoints</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>UsesLocalEndpoints</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// internalPolicyChain is the chain containing the endpoints for
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// &#34;internal&#34; (ClusterIP) traffic. internalTrafficChain is the chain that
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// internal traffic is routed to (which is always the same as
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// internalPolicyChain). hasInternalEndpoints is true if we should
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// generate rules pointing to internalTrafficChain, or false if there are
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// no available internal endpoints.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>internalPolicyChain</span> <span class=o>:=</span> <span class=nx>clusterPolicyChain</span>
</span></span><span class=line><span class=cl>		<span class=nx>hasInternalEndpoints</span> <span class=o>:=</span> <span class=nx>hasEndpoints</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>InternalPolicyLocal</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>internalPolicyChain</span> <span class=p>=</span> <span class=nx>localPolicyChain</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>localEndpoints</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>hasInternalEndpoints</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>internalTrafficChain</span> <span class=o>:=</span> <span class=nx>internalPolicyChain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Similarly, externalPolicyChain is the chain containing the endpoints
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// for &#34;external&#34; (NodePort, LoadBalancer, and ExternalIP) traffic.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// externalTrafficChain is the chain that external traffic is routed to
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// (which is always the service&#39;s &#34;EXT&#34; chain). hasExternalEndpoints is
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// true if there are endpoints that will be reached by external traffic.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// (But we may still have to generate externalTrafficChain even if there
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// are no external endpoints, to ensure that the short-circuit rules for
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// local traffic are set up.)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>externalPolicyChain</span> <span class=o>:=</span> <span class=nx>clusterPolicyChain</span>
</span></span><span class=line><span class=cl>		<span class=nx>hasExternalEndpoints</span> <span class=o>:=</span> <span class=nx>hasEndpoints</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ExternalPolicyLocal</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>externalPolicyChain</span> <span class=p>=</span> <span class=nx>localPolicyChain</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>localEndpoints</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>hasExternalEndpoints</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>externalTrafficChain</span> <span class=o>:=</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nx>externalChainName</span> <span class=c1>// eventually jumps to externalPolicyChain
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>		<span class=c1>// usesExternalTrafficChain is based on hasEndpoints, not hasExternalEndpoints,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// because we need the local-traffic-short-circuiting rules even when there
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// are no externally-usable endpoints.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>usesExternalTrafficChain</span> <span class=o>:=</span> <span class=nx>hasEndpoints</span> <span class=o>&amp;&amp;</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ExternallyAccessible</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Traffic to LoadBalancer IPs can go directly to externalTrafficChain
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// unless LoadBalancerSourceRanges is in use in which case we will
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// create a firewall chain.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>loadBalancerTrafficChain</span> <span class=o>:=</span> <span class=nx>externalTrafficChain</span>
</span></span><span class=line><span class=cl>		<span class=nx>fwChain</span> <span class=o>:=</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nx>firewallChainName</span>
</span></span><span class=line><span class=cl>		<span class=nx>usesFWChain</span> <span class=o>:=</span> <span class=nx>hasEndpoints</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerVIPs</span><span class=p>())</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerSourceRanges</span><span class=p>())</span> <span class=p>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>usesFWChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>loadBalancerTrafficChain</span> <span class=p>=</span> <span class=nx>fwChain</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>internalTrafficFilterTarget</span><span class=p>,</span> <span class=nx>internalTrafficFilterComment</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>externalTrafficFilterTarget</span><span class=p>,</span> <span class=nx>externalTrafficFilterComment</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>hasEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// The service has no endpoints at all; hasInternalEndpoints and
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// hasExternalEndpoints will also be false, and we will not
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// generate any chains in the &#34;nat&#34; table for the service; only
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// rules in the &#34;filter&#34; table rejecting incoming packets for
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// the service&#39;s IPs.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>internalTrafficFilterTarget</span> <span class=p>=</span> <span class=s>&#34;REJECT&#34;</span>
</span></span><span class=line><span class=cl>			<span class=nx>internalTrafficFilterComment</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s has no endpoints&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>externalTrafficFilterTarget</span> <span class=p>=</span> <span class=s>&#34;REJECT&#34;</span>
</span></span><span class=line><span class=cl>			<span class=nx>externalTrafficFilterComment</span> <span class=p>=</span> <span class=nx>internalTrafficFilterComment</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>hasInternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// The internalTrafficPolicy is &#34;Local&#34; but there are no local
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// endpoints. Traffic to the clusterIP will be dropped, but
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// external traffic may still be accepted.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>internalTrafficFilterTarget</span> <span class=p>=</span> <span class=s>&#34;DROP&#34;</span>
</span></span><span class=line><span class=cl>				<span class=nx>internalTrafficFilterComment</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s has no local endpoints&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>serviceNoLocalEndpointsTotalInternal</span><span class=o>++</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>hasExternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// The externalTrafficPolicy is &#34;Local&#34; but there are no
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// local endpoints. Traffic to &#34;external&#34; IPs from outside
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// the cluster will be dropped, but traffic from inside
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// the cluster may still be accepted.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>externalTrafficFilterTarget</span> <span class=p>=</span> <span class=s>&#34;DROP&#34;</span>
</span></span><span class=line><span class=cl>				<span class=nx>externalTrafficFilterComment</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s has no local endpoints&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>serviceNoLocalEndpointsTotalExternal</span><span class=o>++</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>filterRules</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span>
</span></span><span class=line><span class=cl>		<span class=nx>natChains</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span>
</span></span><span class=line><span class=cl>		<span class=nx>natRules</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture the clusterIP.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>hasInternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s cluster IP&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>().</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>internalTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// No endpoints.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>internalTrafficFilterComment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>().</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nx>internalTrafficFilterTarget</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture externalIPs.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>externalIP</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ExternalIPs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>hasEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Send traffic bound for external IPs to the &#34;external
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// destinations&#34; chain.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s external IP&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>externalIP</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>hasExternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Either no endpoints at all (REJECT) or no endpoints for
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// external traffic (DROP anything that didn&#39;t get
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// short-circuited by the EXT chain.)
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeExternalServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>externalTrafficFilterComment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>externalIP</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nx>externalTrafficFilterTarget</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture load-balancer ingress.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>lbip</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerVIPs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>hasEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s loadbalancer IP&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>lbip</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>loadBalancerTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>usesFWChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeProxyFirewallChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s traffic not accepted by %s&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nx>firewallChainName</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>lbip</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;DROP&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>hasExternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Either no endpoints at all (REJECT) or no endpoints for
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// external traffic (DROP anything that didn&#39;t get short-circuited
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// by the EXT chain.)
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>lbip</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerVIPs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeExternalServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>externalTrafficFilterComment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>lbip</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nx>externalTrafficFilterTarget</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture nodeports.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>hasEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Jump to the external destination chain.  For better or for
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// worse, nodeports are not subect to loadBalancerSourceRanges,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// and we can&#39;t change that.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>localhostNodePorts</span> <span class=o>&amp;&amp;</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipFamily</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>IPv4Protocol</span> <span class=o>&amp;&amp;</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nfAcctCounters</span><span class=p>[</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>LocalhostNodePortAcceptedNFAcctCounter</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeNodePortsChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.0/8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;nfacct&#34;</span><span class=p>,</span> <span class=s>&#34;--nfacct-name&#34;</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>LocalhostNodePortAcceptedNFAcctCounter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeNodePortsChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>hasExternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Either no endpoints at all (REJECT) or no endpoints for
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// external traffic (DROP anything that didn&#39;t get
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// short-circuited by the EXT chain.)
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeExternalServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>externalTrafficFilterComment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;addrtype&#34;</span><span class=p>,</span> <span class=s>&#34;--dst-type&#34;</span><span class=p>,</span> <span class=s>&#34;LOCAL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nx>externalTrafficFilterTarget</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture healthCheckNodePorts.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>HealthCheckNodePort</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// no matter if node has local endpoints, healthCheckNodePorts
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// need to add a rule to accept the incoming connection
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeNodePortsChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s health check node port&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=s>&#34;tcp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>HealthCheckNodePort</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;ACCEPT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// If the SVC/SVL/EXT/FW/SEP chains have not changed since the last sync
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// then we can omit them from the restore input. However, we have to still
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// figure out how many chains we _would_ have written, to make the metrics
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// come out right, so we just compute them and throw them away.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>tryPartialSync</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>serviceUpdateResult</span><span class=p>.</span><span class=nx>UpdatedServices</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>svcName</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>endpointUpdateResult</span><span class=p>.</span><span class=nx>UpdatedServices</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>svcName</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>natChains</span> <span class=p>=</span> <span class=nx>skippedNatChains</span>
</span></span><span class=line><span class=cl>			<span class=nx>natRules</span> <span class=p>=</span> <span class=nx>skippedNatRules</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Set up internal traffic handling.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>hasInternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>args</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>args</span><span class=p>[:</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s cluster IP&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>().</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;--dport&#34;</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>masqueradeAll</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>internalTrafficChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=nx>args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeMarkMasqChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>localDetector</span><span class=p>.</span><span class=nf>IsImplemented</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// This masquerades off-cluster traffic to a service VIP. The
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// idea is that you can establish a static route for your
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// Service range, routing to any node, and that node will
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// bridge into the Service for you. Since that might bounce
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// off-node, we masquerade here.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>internalTrafficChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=nx>args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>localDetector</span><span class=p>.</span><span class=nf>IfNotLocal</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeMarkMasqChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Set up external traffic handling (if any &#34;external&#34; destinations are
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// enabled). All captured traffic for all external destinations should
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// jump to externalTrafficChain, which will handle some special cases and
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// then jump to externalPolicyChain.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>usesExternalTrafficChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>natChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>activeNATChains</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ExternalPolicyLocal</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// If we are using non-local endpoints we need to masquerade,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// in case we cross nodes.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;masquerade traffic for %s external destinations&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeMarkMasqChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// If we are only using same-node endpoints, we can retain the
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// source IP in most cases.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>localDetector</span><span class=p>.</span><span class=nf>IsImplemented</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// Treat all locally-originated pod -&gt; external destination
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// traffic as a special-case.  It is subject to neither
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// form of traffic policy, which simulates going up-and-out
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// to an external load-balancer and coming back in.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;pod traffic for %s external destinations&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>						<span class=nx>proxier</span><span class=p>.</span><span class=nx>localDetector</span><span class=p>.</span><span class=nf>IfLocal</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>clusterPolicyChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// Locally originated traffic (not a pod, but the host node)
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// still needs masquerade because the LBIP itself is a local
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// address, so that will be the chosen source IP.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;masquerade LOCAL traffic for %s external destinations&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;addrtype&#34;</span><span class=p>,</span> <span class=s>&#34;--src-type&#34;</span><span class=p>,</span> <span class=s>&#34;LOCAL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeMarkMasqChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// Redirect all src-type=LOCAL -&gt; external destination to the
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// policy=cluster chain. This allows traffic originating
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// from the host to be redirected to the service correctly.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;route LOCAL traffic for %s external destinations&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;addrtype&#34;</span><span class=p>,</span> <span class=s>&#34;--src-type&#34;</span><span class=p>,</span> <span class=s>&#34;LOCAL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>clusterPolicyChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Anything else falls thru to the appropriate policy chain.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>hasExternalEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalPolicyChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Set up firewall chain, if needed
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>usesFWChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>natChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>fwChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>activeNATChains</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>fwChain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// The service firewall rules are created based on the
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// loadBalancerSourceRanges field. This only works for VIP-like
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// loadbalancers that preserve source IPs. For loadbalancers which
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// direct traffic to service NodePort, the firewall rules will not
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// apply.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>args</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>args</span><span class=p>[:</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>fwChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;%s loadbalancer IP&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// firewall filter based on each source range
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>allowFromNode</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>cidr</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerSourceRanges</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=s>&#34;-s&#34;</span><span class=p>,</span> <span class=nx>cidr</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>cidr</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>nodeIP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>allowFromNode</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// For VIP-like LBs, the VIP is often added as a local
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// address (via an IP route rule).  In that case, a request
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// from a node to the VIP will not hit the loadbalancer but
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// will loop back with the source IP set to the VIP.  We
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// need the following rules to allow requests from this node.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>allowFromNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>lbip</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerVIPs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=nx>args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-s&#34;</span><span class=p>,</span> <span class=nx>lbip</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>externalTrafficChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// If the packet was able to reach the end of firewall chain,
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// then it did not get DNATed, so it will match the
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// corresponding KUBE-PROXY-FIREWALL rule.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>fwChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`&#34;other traffic to %s will be dropped by KUBE-PROXY-FIREWALL&#34;`</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// If Cluster policy is in use, create the chain and create rules jumping
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// from clusterPolicyChain to the clusterEndpoints
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>usesClusterPolicyChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>natChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>clusterPolicyChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>activeNATChains</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>clusterPolicyChain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nf>writeServiceToEndpointRules</span><span class=p>(</span><span class=nx>natRules</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>,</span> <span class=nx>clusterPolicyChain</span><span class=p>,</span> <span class=nx>clusterEndpoints</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// If Local policy is in use, create the chain and create rules jumping
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// from localPolicyChain to the localEndpoints
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>usesLocalPolicyChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>natChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>localPolicyChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>activeNATChains</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>localPolicyChain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nf>writeServiceToEndpointRules</span><span class=p>(</span><span class=nx>natRules</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>,</span> <span class=nx>localPolicyChain</span><span class=p>,</span> <span class=nx>localEndpoints</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Generate the per-endpoint chains.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>allLocallyReachableEndpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>epInfo</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>ep</span><span class=p>.(</span><span class=o>*</span><span class=nx>endpointInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Failed to cast endpointInfo&#34;</span><span class=p>,</span> <span class=s>&#34;endpointInfo&#34;</span><span class=p>,</span> <span class=nx>ep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>endpointChain</span> <span class=o>:=</span> <span class=nx>epInfo</span><span class=p>.</span><span class=nx>ChainName</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Create the endpoint chain
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>natChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>endpointChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>activeNATChains</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>endpointChain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>args</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>args</span><span class=p>[:</span><span class=mi>0</span><span class=p>],</span> <span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>endpointChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>args</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>appendServiceCommentLocked</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=nx>svcPortNameString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Handle traffic that loops back to the originator with SNAT.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=nx>args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-s&#34;</span><span class=p>,</span> <span class=nx>epInfo</span><span class=p>.</span><span class=nf>IP</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeMarkMasqChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Update client-affinity lists.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>SessionAffinityType</span><span class=p>()</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ServiceAffinityClientIP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>args</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;recent&#34;</span><span class=p>,</span> <span class=s>&#34;--name&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>endpointChain</span><span class=p>),</span> <span class=s>&#34;--set&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// DNAT to final destination.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>args</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-p&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>,</span> <span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;DNAT&#34;</span><span class=p>,</span> <span class=s>&#34;--to-destination&#34;</span><span class=p>,</span> <span class=nx>epInfo</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Delete chains no longer in use. Since &#34;iptables-save&#34; can take several seconds
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to run on hosts with lots of iptables rules, we don&#39;t bother to do this on
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// every sync in large clusters. (Stale chains will not be referenced by any
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// active rules, so they&#39;re harmless other than taking up memory.)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>deletedChains</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>largeClusterMode</span> <span class=o>||</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>lastIPTablesCleanup</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>syncPeriod</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptables</span><span class=p>.</span><span class=nf>SaveInto</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>TableNAT</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>existingNATChains</span> <span class=o>:=</span> <span class=nx>utiliptables</span><span class=p>.</span><span class=nf>GetChainsFromTable</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>chain</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>existingNATChains</span><span class=p>.</span><span class=nf>Difference</span><span class=p>(</span><span class=nx>activeNATChains</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>chainString</span> <span class=o>:=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>chain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>!</span><span class=nf>isServiceChainName</span><span class=p>(</span><span class=nx>chainString</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// Ignore chains that aren&#39;t ours.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// We must (as per iptables) write a chain-line
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// for it, which has the nice effect of flushing
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// the chain. Then we can remove the chain.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nf>MakeChainLine</span><span class=p>(</span><span class=nx>chain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=s>&#34;-X&#34;</span><span class=p>,</span> <span class=nx>chainString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>deletedChains</span><span class=o>++</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>lastIPTablesCleanup</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to execute iptables-save: stale chains will not be deleted&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Finally, tail-call to the nodePorts chain.  This needs to be after all
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// other service portal rules.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nodePortAddresses</span><span class=p>.</span><span class=nf>MatchAll</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>destinations</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;addrtype&#34;</span><span class=p>,</span> <span class=s>&#34;--dst-type&#34;</span><span class=p>,</span> <span class=s>&#34;LOCAL&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Block localhost nodePorts if they are not supported. (For IPv6 they never
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// work, and for IPv4 they only work if we previously set `route_localnet`.)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>isIPv6</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>destinations</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>destinations</span><span class=p>,</span> <span class=s>&#34;!&#34;</span><span class=p>,</span> <span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=s>&#34;::1/128&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>localhostNodePorts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>destinations</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>destinations</span><span class=p>,</span> <span class=s>&#34;!&#34;</span><span class=p>,</span> <span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.0/8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=s>`&#34;kubernetes service nodeports; NOTE: this must be the last rule in this chain&#34;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>destinations</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeNodePortsChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeIPs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nodePortAddresses</span><span class=p>.</span><span class=nf>GetNodeIPs</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>networkInterfacer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to get node ip address matching nodeport cidrs, services with nodeport may not work as intended&#34;</span><span class=p>,</span> <span class=s>&#34;CIDRs&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nodePortAddresses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ip</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeIPs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ip</span><span class=p>.</span><span class=nf>IsLoopback</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>isIPv6</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;--nodeport-addresses includes localhost but localhost NodePorts are not supported on IPv6&#34;</span><span class=p>,</span> <span class=s>&#34;address&#34;</span><span class=p>,</span> <span class=nx>ip</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>localhostNodePorts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;--nodeport-addresses includes localhost but --iptables-localhost-nodeports=false was passed&#34;</span><span class=p>,</span> <span class=s>&#34;address&#34;</span><span class=p>,</span> <span class=nx>ip</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// create nodeport rules for each IP one by one
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeServicesChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=s>`&#34;kubernetes service nodeports; NOTE: this must be the last rule in this chain&#34;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>ip</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeNodePortsChain</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Drop the packets in INVALID state, which would potentially cause
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// unexpected connection reset if nf_conntrack_tcp_be_liberal is not set.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Ref: https://github.com/kubernetes/kubernetes/issues/74839
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Ref: https://github.com/kubernetes/kubernetes/issues/117924
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>conntrackTCPLiberal</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rule</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeForwardChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;conntrack&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;--ctstate&#34;</span><span class=p>,</span> <span class=s>&#34;INVALID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>nfAcctCounters</span><span class=p>[</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>IPTablesCTStateInvalidDroppedNFAcctCounter</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rule</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;nfacct&#34;</span><span class=p>,</span> <span class=s>&#34;--nfacct-name&#34;</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>IPTablesCTStateInvalidDroppedNFAcctCounter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>rule</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;DROP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>rule</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If the masqueradeMark has been added then we want to forward that same
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// traffic, this allows NodePort traffic to be forwarded even if the default
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// FORWARD policy is not accept.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeForwardChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=s>`&#34;kubernetes forwarding rules&#34;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;mark&#34;</span><span class=p>,</span> <span class=s>&#34;--mark&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/%s&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>masqueradeMark</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>masqueradeMark</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;ACCEPT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following rule ensures the traffic after the initial packet accepted
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by the &#34;kubernetes forwarding rules&#34; rule above will be accepted.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-A&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>kubeForwardChain</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;comment&#34;</span><span class=p>,</span> <span class=s>&#34;--comment&#34;</span><span class=p>,</span> <span class=s>`&#34;kubernetes forwarding conntrack rule&#34;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;conntrack&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;--ctstate&#34;</span><span class=p>,</span> <span class=s>&#34;RELATED,ESTABLISHED&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-j&#34;</span><span class=p>,</span> <span class=s>&#34;ACCEPT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>IPTablesRulesTotal</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>TableFilter</span><span class=p>)).</span><span class=nf>Set</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Lines</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>IPTablesRulesLastSync</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>TableFilter</span><span class=p>)).</span><span class=nf>Set</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Lines</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>IPTablesRulesTotal</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>TableNAT</span><span class=p>)).</span><span class=nf>Set</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Lines</span><span class=p>()</span> <span class=o>+</span> <span class=nx>skippedNatRules</span><span class=p>.</span><span class=nf>Lines</span><span class=p>()</span> <span class=o>-</span> <span class=nx>deletedChains</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>IPTablesRulesLastSync</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>TableNAT</span><span class=p>)).</span><span class=nf>Set</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Lines</span><span class=p>()</span> <span class=o>-</span> <span class=nx>deletedChains</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Sync rules.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;*filter\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>filterChains</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;COMMIT\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;*nat\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;COMMIT\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Reloading service iptables data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;numServices&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>svcPortMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;numEndpoints&#34;</span><span class=p>,</span> <span class=nx>totalEndpoints</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;numFilterChains&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>filterChains</span><span class=p>.</span><span class=nf>Lines</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;numFilterRules&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Lines</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;numNATChains&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span><span class=p>.</span><span class=nf>Lines</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;numNATRules&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Lines</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>9</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Restoring iptables&#34;</span><span class=p>,</span> <span class=s>&#34;rules&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// NOTE: NoFlushTables is used so we don&#39;t flush non-kubernetes chains in the table
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>iptables</span><span class=p>.</span><span class=nf>RestoreAll</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>(),</span> <span class=nx>utiliptables</span><span class=p>.</span><span class=nx>NoFlushTables</span><span class=p>,</span> <span class=nx>utiliptables</span><span class=p>.</span><span class=nx>RestoreCounters</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>pErr</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>utiliptables</span><span class=p>.</span><span class=nx>ParseError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>lines</span> <span class=o>:=</span> <span class=nx>utiliptables</span><span class=p>.</span><span class=nf>ExtractLines</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>iptablesData</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>(),</span> <span class=nx>pErr</span><span class=p>.</span><span class=nf>Line</span><span class=p>(),</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>pErr</span><span class=p>,</span> <span class=s>&#34;Failed to execute iptables-restore&#34;</span><span class=p>,</span> <span class=s>&#34;rules&#34;</span><span class=p>,</span> <span class=nx>lines</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to execute iptables-restore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>IPTablesRestoreFailuresTotal</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>success</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>needFullSync</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>lastChangeTriggerTimes</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>endpointUpdateResult</span><span class=p>.</span><span class=nx>LastChangeTriggerTimes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>lastChangeTriggerTime</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lastChangeTriggerTimes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>latency</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>lastChangeTriggerTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nx>NetworkProgrammingLatency</span><span class=p>.</span><span class=nf>Observe</span><span class=p>(</span><span class=nx>latency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Network programming&#34;</span><span class=p>,</span> <span class=s>&#34;endpoint&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KRef</span><span class=p>(</span><span class=nx>name</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>name</span><span class=p>.</span><span class=nx>Name</span><span class=p>),</span> <span class=s>&#34;elapsed&#34;</span><span class=p>,</span> <span class=nx>latency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>SyncProxyRulesNoLocalEndpointsTotal</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;internal&#34;</span><span class=p>).</span><span class=nf>Set</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>serviceNoLocalEndpointsTotalInternal</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>SyncProxyRulesNoLocalEndpointsTotal</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;external&#34;</span><span class=p>).</span><span class=nf>Set</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>serviceNoLocalEndpointsTotalExternal</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>healthzServer</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>healthzServer</span><span class=p>.</span><span class=nf>Updated</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>ipFamily</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>SyncProxyRulesLastTimestamp</span><span class=p>.</span><span class=nf>SetToCurrentTime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Update service healthchecks.  The endpoints list might include services that are
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// not &#34;OnlyLocal&#34;, but the services list will not, and the serviceHealthServer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// will just drop those endpoints.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceHealthServer</span><span class=p>.</span><span class=nf>SyncServices</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>svcPortMap</span><span class=p>.</span><span class=nf>HealthCheckNodePorts</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error syncing healthcheck services&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceHealthServer</span><span class=p>.</span><span class=nf>SyncEndpoints</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsMap</span><span class=p>.</span><span class=nf>LocalReadyEndpoints</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error syncing healthcheck endpoints&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Finish housekeeping, clear stale conntrack entries for UDP Services
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conntrack</span><span class=p>.</span><span class=nf>CleanStaleEntries</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>conntrack</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>svcPortMap</span><span class=p>,</span> <span class=nx>serviceUpdateResult</span><span class=p>,</span> <span class=nx>endpointUpdateResult</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=24-ipvs的syncproxyrules>2.4 ipvs的syncProxyRules</h3></article><ul class=article-share><li><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=/kube-proxy%25E5%25A6%2582%25E4%25BD%2595%25E7%259B%2591%25E5%2590%25ACservice%25E5%2592%258Cendpoint%25E4%25BB%25A5%25E5%258F%258A%25E6%259B%25B4%25E6%2596%25B0%25E7%25AD%2596%25E7%2595%25A5%25E8%25A7%2584%25E5%2588%2599/" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><i class="fa-brands fa-facebook-f"></i></div>Facebook</div></a></li><li><a class=resp-sharing-button__link href="https://x.com/intent/tweet/?text=%e3%80%90%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90%e3%80%91Kube%20Proxy%e5%a6%82%e4%bd%95%e7%9b%91%e5%90%acService%e5%92%8cEndpoint%e4%bb%a5%e5%8f%8a%e6%9b%b4%e6%96%b0%e7%ad%96%e7%95%a5%e8%a7%84%e5%88%99%20-%20%e7%bb%b4%e4%bf%ae%e5%8c%ba%e5%88%b7%e7%b4%ab&amp;url=/kube-proxy%25E5%25A6%2582%25E4%25BD%2595%25E7%259B%2591%25E5%2590%25ACservice%25E5%2592%258Cendpoint%25E4%25BB%25A5%25E5%258F%258A%25E6%259B%25B4%25E6%2596%25B0%25E7%25AD%2596%25E7%2595%25A5%25E8%25A7%2584%25E5%2588%2599/" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--x resp-sharing-button--medium"><i class="fa-brands fa-x-twitter"></i></div></a></li></ul><ul class="pager article-pager"><li class=pager-newer><a href=/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0argocd-gitops-%E5%AE%9E%E8%B7%B5%E4%B8%80argocd-%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/ data-toggle=tooltip data-placement=top title="【学习笔记】ArgoCD GitOps 实践一：ArgoCD 的安装与配置">&lt; Newer</a></li><li class=pager-older><a href=/%E9%97%AE%E9%A2%98%E5%B0%8F%E8%A7%A3%E5%86%B3%E6%8F%90%E4%BE%9B%E4%B8%80%E4%B8%AA%E7%9B%B4%E6%8E%A5%E8%BF%9B%E5%85%A5pod%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%9A%84shell%E8%84%9A%E6%9C%AC/ data-toggle=tooltip data-placement=top title=【问题小解决】提供一个直接进入Pod网络命名空间的Shell脚本>Older ></a></li></ul></div><div class=site-footer><div class=copyright>© 2025 黄泽宏 | <a href=https://beian.miit.gov.cn/ target=_blank>粤ICP备2025417888号-1</a></div><ul class=site-footer-items><li class=site-footer-item-about><a href=/about/ title=About>About</a></li></ul><div class=powerdby>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/taikii/whiteplain>Whiteplain</a>
<script>fetch("https://ghtrk-pixel.fly.dev/goodtracker.png?from=hugo-footer-huangzehong_me&ts="+Date.now())</script></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-16F0MHER15"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-16F0MHER15",{anonymize_ip:!1})}</script></body></html>