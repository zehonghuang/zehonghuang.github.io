<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>【生产问题】分享一次Nginx正向代理的需求 - 维修区刷紫</title>
<meta property="og:title" content="【生产问题】分享一次Nginx正向代理的需求 - 维修区刷紫"><meta name=twitter:title content="【生产问题】分享一次Nginx正向代理的需求 - 维修区刷紫"><meta name=description content="
最近接到了一个需求：通过 Nginx 代理把现网一个自研代理程序给替换掉，感觉有点意思，也有所收益，简单分享下。

需求背景
部门的生产环境异常复杂，有部分第三方引入的系统位于特殊网络隔离区域，请求这些系统需要通过 2 层网络代理，如图所示：

中心源系统请求目标系统 API 的形式各异，我简单收集了下，至少有如下 3 种：


1
2
3
4
5


curl --digest -u admin:xxxxxx 'http://10.xxx.xxx.xxx:8080/foo/boo?Id=123456789&amp;vId=1234' 
 
curl -d '{&#34;eventId&#34;: 20171116, &#34;timestamp&#34;: 123456, &#34;caller&#34;: &#34;XXP&#34;, &#34;version&#34;: &#34;1.0&#34;, &#34;interface&#34;: {&#34;interfaceName&#34;: &#34;XXPVC&#34;, &#34;para&#34;: {&#34;detail&#34;: {&#34;owner&#34;: &#34;xxxxxxx&#34;}}}, &#34;password&#34;: &#34;xxxxxx&#34;, &#34;callee&#34;: &#34;XXPVC&#34;}' http://10.x.x.x:8080/t/api
 
curl -X PUT -H &#34;Content-Type: application/json&#34; -d'{&#34;vp&#34;:{&#34;id&#34;:&#34;ab27adc8-xxx-xxxx-a732-fbde162ebdd3&#34;}}' &#34;http://10.x.x.x/v1.0/peers/show_connectioninfos&#34;


"><meta property="og:description" content="
最近接到了一个需求：通过 Nginx 代理把现网一个自研代理程序给替换掉，感觉有点意思，也有所收益，简单分享下。

需求背景
部门的生产环境异常复杂，有部分第三方引入的系统位于特殊网络隔离区域，请求这些系统需要通过 2 层网络代理，如图所示：

中心源系统请求目标系统 API 的形式各异，我简单收集了下，至少有如下 3 种：


1
2
3
4
5


curl --digest -u admin:xxxxxx 'http://10.xxx.xxx.xxx:8080/foo/boo?Id=123456789&amp;vId=1234' 
 
curl -d '{&#34;eventId&#34;: 20171116, &#34;timestamp&#34;: 123456, &#34;caller&#34;: &#34;XXP&#34;, &#34;version&#34;: &#34;1.0&#34;, &#34;interface&#34;: {&#34;interfaceName&#34;: &#34;XXPVC&#34;, &#34;para&#34;: {&#34;detail&#34;: {&#34;owner&#34;: &#34;xxxxxxx&#34;}}}, &#34;password&#34;: &#34;xxxxxx&#34;, &#34;callee&#34;: &#34;XXPVC&#34;}' http://10.x.x.x:8080/t/api
 
curl -X PUT -H &#34;Content-Type: application/json&#34; -d'{&#34;vp&#34;:{&#34;id&#34;:&#34;ab27adc8-xxx-xxxx-a732-fbde162ebdd3&#34;}}' &#34;http://10.x.x.x/v1.0/peers/show_connectioninfos&#34;


"><meta name=twitter:description content="
最近接到了一个需求：通过 Nginx 代理把现网一个自研代理程序给替换掉，感觉有点意思，也有所收益，简单分享下。

需求背景
部门的生产环境异常复杂，有部分第三方引入的系统位于特殊网络隔离区域，请求这些系统需要通过 2 层网络代理，如图所示：

中心源系统请求目标系统 API 的形式各异，我简单收集了下，至少有如下 3 种：


1
2
3
4
5


curl --digest -u …"><meta name=author content="金汤力"><link rel=icon type=image/x-icon href=/images/favicon.ico><meta property="og:site_name" content="维修区刷紫"><meta property="og:url" content="/%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98%E5%88%86%E4%BA%AB%E4%B8%80%E6%AC%A1nginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E9%9C%80%E6%B1%82/"><meta property="og:type" content="article"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.120.2"><script src=https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/Base64/1.3.0/base64.min.js integrity="sha512-IFxgh3q1bUsg/sL6qotMkJZTOvPyYSS6mRSSIVnJndN5j9vWcQ+oJyHkelIkRAOaKgdU1ibHJOs4HX15sPtZKw==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b5f7da576488071eb46ec9fe633fa64",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=stylesheet href=/css/style.css media=all><link rel=stylesheet href=/css/style-dark.css media="all and (prefers-color-scheme: dark)"><link rel=stylesheet href=/css/syntax.css media=all><link rel=stylesheet href=/css/custom.css media=all><script src=/js/script.js></script><script src=/js/custom.js></script><script defer src=/fontawesome/all.min.js></script></head><body><header class=site-header><nav class=site-navi><h1 class=site-title><a href=/>维修区刷紫</a></h1><ul class=site-navi-items><li class=site-navi-item-archives><a href=/archives/ title=所有文章>所有文章</a></li><li class=site-navi-item-categories><a href=/categories/ title=类别>类别</a></li><li class=site-navi-item-about><a href=/about/ title=关于我>关于我</a></li></ul></nav></header><hr class=site-header-bottom><div class=main role=main><article class=article><h1 class=article-title>【生产问题】分享一次Nginx正向代理的需求</h1><hr class=article-title-bottom><ul class=article-meta><li class=article-meta-date><time>2020-04-17</time></li><li class=article-meta-categories><a href=/categories/linux/><i class="fa-solid fa-folder"></i>
Linux
</a>&nbsp;</li><li class=article-meta-categories><a href=/categories/nginx/><i class="fa-solid fa-folder"></i>
Nginx
</a>&nbsp;</li><li class=article-meta-categories><a href=/categories/%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98/><i class="fa-solid fa-folder"></i>
生产问题
</a>&nbsp;</li></ul><blockquote><p>最近接到了一个需求：通过 Nginx 代理把现网一个自研代理程序给替换掉，感觉有点意思，也有所收益，简单分享下。</p></blockquote><h3 id=需求背景>需求背景</h3><p>部门的生产环境异常复杂，有部分第三方引入的系统位于特殊网络隔离区域，请求这些系统需要通过 2 层网络代理，如图所示：</p><p><img src=/images/12.png alt=12></p><p>中心源系统请求目标系统 API 的形式各异，我简单收集了下，至少有如下 3 种：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl --digest -u admin:xxxxxx <span class=s1>&#39;http://10.xxx.xxx.xxx:8080/foo/boo?Id=123456789&amp;vId=1234&#39;</span> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>curl -d <span class=s1>&#39;{&#34;eventId&#34;: 20171116, &#34;timestamp&#34;: 123456, &#34;caller&#34;: &#34;XXP&#34;, &#34;version&#34;: &#34;1.0&#34;, &#34;interface&#34;: {&#34;interfaceName&#34;: &#34;XXPVC&#34;, &#34;para&#34;: {&#34;detail&#34;: {&#34;owner&#34;: &#34;xxxxxxx&#34;}}}, &#34;password&#34;: &#34;xxxxxx&#34;, &#34;callee&#34;: &#34;XXPVC&#34;}&#39;</span> http://10.x.x.x:8080/t/api
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>curl -X PUT -H <span class=s2>&#34;Content-Type: application/json&#34;</span> -d<span class=s1>&#39;{&#34;vp&#34;:{&#34;id&#34;:&#34;ab27adc8-xxx-xxxx-a732-fbde162ebdd3&#34;}}&#39;</span> <span class=s2>&#34;http://10.x.x.x/v1.0/peers/show_connectioninfos&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>目前开发同事是用 lighthttp 二次开发实现了这个需求（猜测用到了一堆判断和转发逻辑），存在一定的后期维护工作量，而且这个 GG 已经转岗去其他部门了，现任开发 GG 就想直接通过 Nginx 代理来实现，淘汰这个组件，因此就将这个需求丢给了我这个运维了。</p><h3 id=需求分析>需求分析</h3><p>拿到需求后，我分析了下，应该需要使用正向代理来实现，我们来看下普通的一级正向代理写法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>server <span class=o>{</span>  
</span></span><span class=line><span class=cl>    listen  8080<span class=p>;</span>  
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>  
</span></span><span class=line><span class=cl>        proxy_pass http://<span class=nv>$host$request_uri</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个规则的意思是将所有请求都代理到请求对应的主机。这个在内网正向代理上网的时候会用到，这时候用户只需要将你提供的代理设置为 http_proxy，就可以访问到直接访问不到的站点。</p><p>看起来好像可以满足需求了，But&mldr;实际需求是要经过 2 层代理，那第一层代理的$host 必须是固定为第二层代理的地址了！而且 Nginx 也不支持类似 http_proxy 的设置，所以照搬正向代理是行不通的。</p><h3 id=最终解决>最终解决</h3><p>既然正向代理涉及到自动提取目标主机、端口以及请求的特性，那我们就自己设计一个请求方式，方便使用 Nginx 自带规则来提取并自动代理。</p><p>我和开发约定了一个请求方式（之前也用了类似约定），方便 Nginx 来提取变量并自动代理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl --digest -u admin:xxxxx <span class=s1>&#39;http://10.x.x.x/?proxy_schema=http&amp;proxy_host=x.x.x.x:8080&amp;proxy_url=/XXX/api?tId=123456&amp;fooid=1234&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>将真正需要请求的 API 拆成： ?schema=http&amp;host=主机:端口&amp;proxy_url=请求路径及参数，然后请求到第一级 Nginx 代理服务，一级代理将请求原样传给 Nginx 二级代理，然后在二级代理上通过正则提取 schema、host 和 proxy_url，并代理请求，即可满足需求。</p><p>Nginx 一级代理规则（反向代理）：反向代理到 2 个二级代理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>upstream proxy_svr <span class=o>{</span> 
</span></span><span class=line><span class=cl>    server 192.168.2.100:8080<span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>  
</span></span><span class=line><span class=cl>    listen  8080<span class=p>;</span>  
</span></span><span class=line><span class=cl>    access_log /data/wwwlogs/access.log access<span class=p>;</span>
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>
</span></span><span class=line><span class=cl>        proxy_pass http://proxy_svr<span class=nv>$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span> 
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Nginx 二级代理规则（正向代理）：自动提取 url 里面约定的协议、目标主机和 url 并代理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>server <span class=o>{</span>  
</span></span><span class=line><span class=cl>    listen  8080<span class=p>;</span>  
</span></span><span class=line><span class=cl>    <span class=c1>#resolver 223.5.5.5; # 如果被代理的地址存在域名，需要加一个 dns 配置，否则会 502，报错信息为：no resolver defined to resolve xxx.com</span>
</span></span><span class=line><span class=cl>    access_log /data/wwwlogs/access.log access<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>set</span> <span class=nv>$proxy_schema</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>set</span> <span class=nv>$proxy_host</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>set</span> <span class=nv>$proxy_url</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 提取请求中的 schema 值：</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span> <span class=nv>$request_uri</span> ~ <span class=o>(</span><span class=nv>proxy_schema</span><span class=o>=([</span>^<span class=p>&amp;</span><span class=o>]</span>+<span class=o>))){</span>
</span></span><span class=line><span class=cl>        <span class=nb>set</span> <span class=nv>$proxy_schema</span> <span class=nv>$2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># 提取请求中的 host 值：</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span> <span class=nv>$request_uri</span> ~ <span class=o>(</span><span class=nv>proxy_host</span><span class=o>=([</span>^<span class=p>&amp;</span><span class=o>]</span>+<span class=o>))){</span>
</span></span><span class=line><span class=cl>        <span class=nb>set</span> <span class=nv>$proxy_host</span> <span class=nv>$2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># 提取请求中的 proxy_url 值：</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span> <span class=nv>$request_uri</span> ~ <span class=o>(</span><span class=nv>proxy_url</span><span class=o>=(</span>.*<span class=o>)</span>$<span class=o>)){</span>
</span></span><span class=line><span class=cl>        <span class=nb>set</span> <span class=nv>$proxy_url</span> <span class=nv>$2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># 如果没能提取到则返回 404</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=nv>$proxy_url</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> 404<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=nv>$proxy_host</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> 404<span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># 将提取到的请求请求转发到提取到的主机上</span>
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=c1># 其他 proxy 优化参数略..</span>
</span></span><span class=line><span class=cl>       proxy_pass <span class=nv>$proxy_schema</span>://<span class=nv>$proxy_host$proxy_url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后再套了一层负载均衡，最终生产环境的拓扑如下：</p></article><ul class=article-share><li><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=/%25E7%2594%259F%25E4%25BA%25A7%25E9%2597%25AE%25E9%25A2%2598%25E5%2588%2586%25E4%25BA%25AB%25E4%25B8%2580%25E6%25AC%25A1nginx%25E6%25AD%25A3%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E7%259A%2584%25E9%259C%2580%25E6%25B1%2582/" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><i class="fa-brands fa-facebook-f"></i></div>Facebook</div></a></li><li><a class=resp-sharing-button__link href="https://x.com/intent/tweet/?text=%e3%80%90%e7%94%9f%e4%ba%a7%e9%97%ae%e9%a2%98%e3%80%91%e5%88%86%e4%ba%ab%e4%b8%80%e6%ac%a1Nginx%e6%ad%a3%e5%90%91%e4%bb%a3%e7%90%86%e7%9a%84%e9%9c%80%e6%b1%82%20-%20%e7%bb%b4%e4%bf%ae%e5%8c%ba%e5%88%b7%e7%b4%ab&amp;url=/%25E7%2594%259F%25E4%25BA%25A7%25E9%2597%25AE%25E9%25A2%2598%25E5%2588%2586%25E4%25BA%25AB%25E4%25B8%2580%25E6%25AC%25A1nginx%25E6%25AD%25A3%25E5%2590%2591%25E4%25BB%25A3%25E7%2590%2586%25E7%259A%2584%25E9%259C%2580%25E6%25B1%2582/" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--x resp-sharing-button--medium"><i class="fa-brands fa-x-twitter"></i></div></a></li></ul><ul class="pager article-pager"><li class=pager-newer><a href=/%E9%97%AE%E9%A2%98%E5%B0%8F%E8%A7%A3%E5%86%B3mysql%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E4%B9%8B%E5%8F%8C%E4%B8%BB%E5%A4%9A%E4%BB%8E/ data-toggle=tooltip data-placement=top title=【问题小解决】MySQL高可用集群之双主多从>&lt; Newer</a></li><li class=pager-older><a href=/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86linux%E7%9A%84xargs%E5%91%BD%E4%BB%A4/ data-toggle=tooltip data-placement=top title=【基础知识】Linux的xargs命令>Older ></a></li></ul></div><div class=site-footer><div class=copyright>© 2025 黄泽宏 | <a href=https://beian.miit.gov.cn/ target=_blank>粤ICP备2025417888号-1</a></div><ul class=site-footer-items><li class=site-footer-item-about><a href=/about/ title=About>About</a></li></ul><div class=powerdby>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/taikii/whiteplain>Whiteplain</a>
<script>fetch("https://ghtrk-pixel.fly.dev/goodtracker.png?from=hugo-footer-huangzehong_me&ts="+Date.now())</script></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-16F0MHER15"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-16F0MHER15",{anonymize_ip:!1})}</script></body></html>