+++
title = '【问题大排查】一般环境的网络排障'
date = 2022-07-26T23:08:16+08:00
draft = false
categories = [
    "深度解析",
    "Kubernetes",
]
weight = 2
+++

> 因为最近一段时间，一直在处理各种网路问题，所以痛定思痛从头梳理**一般运维环境下的网络状况**

## 网络不通（持续性）

这个情况没啥好说的，只要不是 DNS 问题，就是服务器挂掉或者端口被禁

### 端口监听挂掉
如果容器内的端口已经没有进程监听了，内核就会返回 Reset 包，客户端就会报错连接被拒绝，可以进容器 netns 检查下端口是否存活:

```shell
netstat -tunlp
```

### iptables 规则问题

检查报文是否有命中丢弃报文的 iptables 规则:

```shell
iptables -t filter -nvL
iptables -t nat -nvL
iptables -t raw -nvL
iptables -t mangle -nvL
iptables-save
```
<!--more-->

## 网络偶尔丢包

网络丢包一般现象就是**偶尔不通或者速度很慢**.

#### 高并发 NAT 导致 conntrack 插入冲突

如果高并发并且做了 NAT，比如使用了 ip-masq-agent，对集群外的网段或公网进行 SNAT，又或者集群内访问 Service 被做了 DNAT，
再加上高并发的话，内核就会高并发进行 NAT 和 conntrack 插入，当并发 NAT 后五元组冲突，最终插入的时候只有先插入的那个成功，另外冲突的就会插入失败，然后就丢包了。

可以通过 conntrack -S 确认，如果 insert_failed 计数在增加，说明有 conntrack 插入冲突。

看内核日志:
```shell
# demsg
$ journalctl -k | grep "nf_conntrack: table full"
nf_conntrack: nf_conntrack: table full, dropping packet
```
若有以上报错，证明 conntrack 表满了，需要调大 conntrack 表:
```shell
sysctl -w net.netfilter.nf_conntrack_max=1000000
```
socket buffer 满导致丢包
`netstat -s | grep "buffer errors"`的计数统计在增加，说明流量较大，socket buffer 不够用，需要调大下 buffer 容量:
```shell
net.ipv4.tcp_wmem = 4096        16384   4194304
net.ipv4.tcp_rmem = 4096        87380   6291456
net.ipv4.tcp_mem = 381462       508616  762924
net.core.rmem_default = 8388608
net.core.rmem_max = 26214400
net.core.wmem_max = 26214400
```

### arp 表爆满

看内核日志:
```shell
# demsg
$ journalctl -k | grep "neighbor table overflow"
arp_cache: neighbor table overflow!
```
若有以上报错，证明 arp 表满了，查看当前 arp 记录数:
```shell
$ arp -an | wc -l
1335
```
查看 arp gc 阀值:
```shell
$ sysctl -a | grep gc_thresh
## 系统在 ARP 表中的条目数量低于该值时，垃圾回收不被触发，表示最小保持的 ARP 条目数
net.ipv4.neigh.default.gc_thresh1 = 128
## ARP 表中的条目数超过该值时，系统会尝试回收一些条目，这是回收的软阈值
net.ipv4.neigh.default.gc_thresh2 = 512
## ARP 表的最大容量，超过此值后，新的 ARP 条目将无法被添加
net.ipv4.neigh.default.gc_thresh3 = 1024
```
调大 arp 表:
```shell
sysctl -w net.ipv4.neigh.default.gc_thresh1=80000
sysctl -w net.ipv4.neigh.default.gc_thresh2=90000
sysctl -w net.ipv4.neigh.default.gc_thresh3=100000
```


