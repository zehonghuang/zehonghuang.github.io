+++
title = '【生产问题】如何将传统运维环境服务优雅地迁移至Kubernetes集群从而实现全量容器化'
date = 2024-09-11T18:13:39+08:00
draft = false
categories = [
    "Kubernetes",
    "生产问题",
]
+++

> 最近尝试着面试几家公司，偶尔会被问到传统环境如何向Kubernetes迁移的方案。
> 
> 坦白说，其实这方面并不缺简单可行性高的方案，我就以屈臣氏中国的迁移方案为例，给访问本博客的同行借鉴一下。

## 环境的迁移，迁移的是什么？

**毋庸置疑，只要外网请求全量并正常地访问Kubernetes环境，我们就可以认为实现了容器化。**

> 流量导入可能还不够，有的公司可能想实现全面云原生，持久层也想迁移进来，涉及到数据库如何尽最大可能无缝迁移。

### 流量迁移

我这里直接按照阿里云传统的ECS环境迁移到自建K8s环境为例

<!--more-->

[ALB配置域名和路径的转发规则](https://help.aliyun.com/zh/slb/application-load-balancer/user-guide/create-a-domain-name-based-or-url-based-forwarding-rule?spm=a2c4g.11186623.0.0.15ea43b5Hz7twr)

### 数据库迁移

### 分布式数据库

> 核心步骤就两个：
> 1. 找到裸机部署的集群，确认是否允许在线添加新节点
> 2. 确认分布式数据库是否支持云原生搭建，主流分布式数据基本上都支持
> 3. 新建Kuberentes节点，设置Taint和topology，避免其他Pod调度上来，并暴露NodePort
> 4. 到通过Helm或其他工具部署在K8s部署新节点，再通过官方工具将节点加入集群中
> 5. 市面上大多数分布式数据库都是 Raft 算法实现的，所以新节点都会使 commitLog 追上 master 后才加入竞选
> 6. 开始对裸机部署的节点进行缩容，使其K8s节点远多余裸机节点，可以手动网络分区让K8s节点自然竞选成功，再缩减裸机节点
> 7. 最后关闭NodePort

我这里用 TiDB 为完整例子展示全过程：

1. 用pd-ctl 命令来确认集群是正常的

### 传统单体数据库

> 主要在于VIP
