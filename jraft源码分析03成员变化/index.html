<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>【JRaft源码分析03】成员变化 - 维修区刷紫</title>
<meta property="og:title" content="【JRaft源码分析03】成员变化 - 维修区刷紫"><meta name=twitter:title content="【JRaft源码分析03】成员变化 - 维修区刷紫"><meta name=description content="第三篇说成员变化，有了对选举和日志复制的认识，这个模块就很轻松简单了。
成员变化就两种情况，增加删除更换节点，和转移领导人。
1、更改一般节点
"><meta property="og:description" content="第三篇说成员变化，有了对选举和日志复制的认识，这个模块就很轻松简单了。
成员变化就两种情况，增加删除更换节点，和转移领导人。
1、更改一般节点
"><meta name=twitter:description content="第三篇说成员变化，有了对选举和日志复制的认识，这个模块就很轻松简单了。
成员变化就两种情况，增加删除更换节点，和转移领导人。
1、更改一般节点
"><meta name=author content="金汤力"><link rel=icon type=image/x-icon href=/images/favicon.ico><meta property="og:site_name" content="维修区刷紫"><meta property="og:url" content="/jraft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9003%E6%88%90%E5%91%98%E5%8F%98%E5%8C%96/"><meta property="og:type" content="article"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.120.2"><script src=https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/Base64/1.3.0/base64.min.js integrity="sha512-IFxgh3q1bUsg/sL6qotMkJZTOvPyYSS6mRSSIVnJndN5j9vWcQ+oJyHkelIkRAOaKgdU1ibHJOs4HX15sPtZKw==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b5f7da576488071eb46ec9fe633fa64",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=stylesheet href=/css/style.css media=all><link rel=stylesheet href=/css/style-dark.css media="all and (prefers-color-scheme: dark)"><link rel=stylesheet href=/css/syntax.css media=all><link rel=stylesheet href=/css/custom.css media=all><script src=/js/script.js></script><script src=/js/custom.js></script><script defer src=/fontawesome/all.min.js></script></head><body><header class=site-header><nav class=site-navi><h1 class=site-title><a href=/>维修区刷紫</a></h1><ul class=site-navi-items><li class=site-navi-item-archives><a href=/archives/ title=所有文章>所有文章</a></li><li class=site-navi-item-categories><a href=/categories/ title=类别>类别</a></li><li class=site-navi-item-about><a href=/about/ title=关于我>关于我</a></li></ul></nav></header><hr class=site-header-bottom><div class=main role=main><article class=article><h1 class=article-title>【JRaft源码分析03】成员变化</h1><hr class=article-title-bottom><ul class=article-meta><li class=article-meta-date><time>2021-03-17</time></li><li class=article-meta-categories><a href=/categories/cap%E7%90%86%E8%AE%BA/><i class="fa-solid fa-folder"></i>
CAP理论
</a>&nbsp;</li><li class=article-meta-categories><a href=/categories/raft%E7%AE%97%E6%B3%95/><i class="fa-solid fa-folder"></i>
RAFT算法
</a>&nbsp;</li><li class=article-meta-categories><a href=/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7/><i class="fa-solid fa-folder"></i>
分布式一致性
</a>&nbsp;</li><li class=article-meta-categories><a href=/categories/java/><i class="fa-solid fa-folder"></i>
java
</a>&nbsp;</li></ul><aside class=toc><nav id=TableOfContents><ul><li><a href=#1更改一般节点>1、更改一般节点</a><ul><li><a href=#11日志追赶stage_catching_up>1.1、日志追赶(STAGE_CATCHING_UP)</a></li><li><a href=#12同步配置信息stage_joint--stage_stable>1.2、同步配置信息(STAGE_JOINT & STAGE_STABLE)</a></li></ul></li><li><a href=#2leader转移>2、Leader转移</a></li></ul></nav></aside><p>第三篇说成员变化，有了对选举和日志复制的认识，这个模块就很轻松简单了。</p><p>成员变化就两种情况，增加删除更换节点，和转移领导人。</p><h2 id=1更改一般节点>1、更改一般节点</h2><p><img src=https://raw.githubusercontent.com/zehonghuang/github_blog_bak/master/source/image/%E4%B8%80%E8%88%AC%E8%8A%82%E7%82%B9%E6%88%90%E5%91%98%E5%8F%98%E5%8C%96.png alt=一般成员节点变化></p><p>这张图看起来很复杂，但整体流程其实很简单，非常清晰明了的。下面的方法就是修改配置的统一入口。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unsafeRegisterConfChange</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>oldConf</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>newConf</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Closure</span><span class=w> </span><span class=n>done</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Requires</span><span class=p>.</span><span class=na>requireTrue</span><span class=p>(</span><span class=n>newConf</span><span class=p>.</span><span class=na>isValid</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;Invalid new conf: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>newConf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// The new conf entry(will be stored in log manager) should be valid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Requires</span><span class=p>.</span><span class=na>requireTrue</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ConfigurationEntry</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>newConf</span><span class=p>,</span><span class=w> </span><span class=n>oldConf</span><span class=p>).</span><span class=na>isValid</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;Invalid conf entry: %s&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>newConf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>STATE_LEADER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 配置正在更改中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>confCtx</span><span class=p>.</span><span class=na>isBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>done</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Utils</span><span class=p>.</span><span class=na>runClosureInThread</span><span class=p>(</span><span class=n>done</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=n>RaftError</span><span class=p>.</span><span class=na>EBUSY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Doing another configuration change.&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>conf</span><span class=p>.</span><span class=na>getConf</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>newConf</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Utils</span><span class=p>.</span><span class=na>runClosureInThread</span><span class=p>(</span><span class=n>done</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>confCtx</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>oldConf</span><span class=p>,</span><span class=w> </span><span class=n>newConf</span><span class=p>,</span><span class=w> </span><span class=n>done</span><span class=p>);</span><span class=c1>//ConfigurationCtx，启动更新配置流程。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>JRaft把更新配置拆解为四个步骤：</p><ul><li>1、STAGE_CATCHING_UP<ul><li>如果有追加或更换新节点，需要使新节点日志跟集群同步，复制完成日志后，调用catchUpClosure，下一步</li></ul></li><li>2、STAGE_JOINT<ul><li>将新旧配置复制到Follower，收到大部分回应后，下一步</li></ul></li><li>3、STAGE_STABLE<ul><li>通知Follower删除旧配置，收到大部分回应后，下一步</li></ul></li><li>4、STAGE_NONE<ul><li>✅</li></ul></li></ul><h3 id=11日志追赶stage_catching_up>1.1、日志追赶(STAGE_CATCHING_UP)</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>oldConf</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>newConf</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Closure</span><span class=w> </span><span class=n>done</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>done</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>done</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>STAGE_CATCHING_UP</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>oldPeers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldConf</span><span class=p>.</span><span class=na>listPeers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>newPeers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newConf</span><span class=p>.</span><span class=na>listPeers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>oldLearners</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldConf</span><span class=p>.</span><span class=na>listLearners</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>newLearners</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newConf</span><span class=p>.</span><span class=na>listLearners</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>adding</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>removing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>newConf</span><span class=p>.</span><span class=na>diff</span><span class=p>(</span><span class=n>oldConf</span><span class=p>,</span><span class=w> </span><span class=n>adding</span><span class=p>,</span><span class=w> </span><span class=n>removing</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>nchanges</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adding</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>removing</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>addNewLearners</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>adding</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=c1>//只删不增</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nextStage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>addNewPeers</span><span class=p>(</span><span class=n>adding</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addNewPeers</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>adding</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>addingPeers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adding</span><span class=p>.</span><span class=na>listPeers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>PeerId</span><span class=w> </span><span class=n>newPeer</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>addingPeers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>replicatorGroup</span><span class=p>.</span><span class=na>addReplicator</span><span class=p>(</span><span class=n>newPeer</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>onCaughtUp</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>version</span><span class=p>,</span><span class=w> </span><span class=n>newPeer</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=c1>//复制器启动异常，立即放弃追赶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>OnCaughtUp</span><span class=w> </span><span class=n>caughtUp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OnCaughtUp</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>currTerm</span><span class=p>,</span><span class=w> </span><span class=n>newPeer</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>version</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>dueTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Utils</span><span class=p>.</span><span class=na>nowMs</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>options</span><span class=p>.</span><span class=na>getElectionTimeoutMs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//设置caughtUp回调，等待replicator完成复制工作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>replicatorGroup</span><span class=p>.</span><span class=na>waitCaughtUp</span><span class=p>(</span><span class=n>newPeer</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>options</span><span class=p>.</span><span class=na>getCatchupMargin</span><span class=p>(),</span><span class=w> </span><span class=n>dueTime</span><span class=p>,</span><span class=w> </span><span class=n>caughtUp</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>onCaughtUp</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>version</span><span class=p>,</span><span class=w> </span><span class=n>newPeer</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>Replicator</code>启动后依旧做日常工作，<code>onAppendEntriesReturned</code>每次复制成功都会执行<code>r.notifyOnCaughtUp(RaftError.SUCCESS.getNumber(), false)</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>notifyOnCaughtUp</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>beforeDestroy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>catchUpClosure</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//这里有一大段关于waitCaughtUp定时器的，不说了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>CatchUpClosure</span><span class=w> </span><span class=n>savedClosure</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>catchUpClosure</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>catchUpClosure</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Utils</span><span class=p>.</span><span class=na>runClosureInThread</span><span class=p>(</span><span class=n>savedClosure</span><span class=p>,</span><span class=w> </span><span class=n>savedClosure</span><span class=p>.</span><span class=na>getStatus</span><span class=p>());</span><span class=c1>//执行上面说到的OnCaughtUp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCaughtUp</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>PeerId</span><span class=w> </span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>term</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>version</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=n>st</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>writeLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 被选下去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>term</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>currTerm</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>STATE_LEADER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=na>isOk</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Caught up successfully</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>confCtx</span><span class=p>.</span><span class=na>onCaughtUp</span><span class=p>(</span><span class=n>version</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 超时继续等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=na>getCode</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RaftError</span><span class=p>.</span><span class=na>ETIMEDOUT</span><span class=p>.</span><span class=na>getNumber</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>Utils</span><span class=p>.</span><span class=na>monotonicMs</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>replicatorGroup</span><span class=p>.</span><span class=na>getLastRpcSendTimestamp</span><span class=p>(</span><span class=n>peer</span><span class=p>)</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>options</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getElectionTimeoutMs</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>confCtx</span><span class=p>.</span><span class=na>onCaughtUp</span><span class=p>(</span><span class=n>version</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>writeLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>alipay</span><span class=p>.</span><span class=na>sofa</span><span class=p>.</span><span class=na>jraft</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>NodeImpl</span><span class=p>.</span><span class=na>ConfigurationCtx</span><span class=err>#</span><span class=n>onCaughtUp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>version</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>PeerId</span><span class=w> </span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Requires</span><span class=p>.</span><span class=na>requireTrue</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>stage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>STAGE_CATCHING_UP</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Stage is not in STAGE_CATCHING_UP&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>success</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>addingPeers</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>peer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>addingPeers</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>nextStage</span><span class=p>();</span><span class=c1>//下一步，STAGE_JOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>reset</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=n>RaftError</span><span class=p>.</span><span class=na>ECATCHUP</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Peer %s failed to catch up.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=12同步配置信息stage_joint--stage_stable>1.2、同步配置信息(STAGE_JOINT & STAGE_STABLE)</h3><p>这个过程有两个步骤，第一步同步新旧配置，所有写入操作兼容两种配置，第二步则是通知Follwer删除旧配置。</p><p>在过渡到第二步之前，Leader需要new & old quonum &lt;=0，才能提交数据。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//com.alipay.sofa.jraft.core.NodeImpl.ConfigurationCtx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>nextStage</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Requires</span><span class=p>.</span><span class=na>requireTrue</span><span class=p>(</span><span class=n>isBusy</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;Not in busy stage&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>stage</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>STAGE_CATCHING_UP</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>nchanges</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>STAGE_JOINT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>unsafeApplyConfiguration</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>newPeers</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>newLearners</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>oldPeers</span><span class=p>),</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=c1>// new and old</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果只更改一个节点，网络出现故障的情况下，新增节点要么被孤立要么融入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 删除节点要么成功要么被孤立，不影响系统可用性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 可以跳过同时保留新旧配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>STAGE_JOINT</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>STAGE_STABLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>unsafeApplyConfiguration</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>newPeers</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>newLearners</span><span class=p>),</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w> </span><span class=c1>// only new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>STAGE_STABLE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>shouldStepDown</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>newPeers</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>serverId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reset</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldStepDown</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>stepDown</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>node</span><span class=p>.</span><span class=na>currTerm</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=n>RaftError</span><span class=p>.</span><span class=na>ELEADERREMOVED</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;This node was removed.&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>STAGE_NONE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// noinspection ConstantConditions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Requires</span><span class=p>.</span><span class=na>requireTrue</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Can&#39;t reach here&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//写日志，等复制给Follower后，调用configurationChangeDone，进入下一步STAGE_STABLE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>unsafeApplyConfiguration</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>newConf</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>oldConf</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                          </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>leaderStart</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Requires</span><span class=p>.</span><span class=na>requireTrue</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>confCtx</span><span class=p>.</span><span class=na>isBusy</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;ConfigurationContext is not busy&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>LogEntry</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LogEntry</span><span class=p>(</span><span class=n>EnumOutter</span><span class=p>.</span><span class=na>EntryType</span><span class=p>.</span><span class=na>ENTRY_TYPE_CONFIGURATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>entry</span><span class=p>.</span><span class=na>setId</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>LogId</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>currTerm</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>entry</span><span class=p>.</span><span class=na>setPeers</span><span class=p>(</span><span class=n>newConf</span><span class=p>.</span><span class=na>listPeers</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>entry</span><span class=p>.</span><span class=na>setLearners</span><span class=p>(</span><span class=n>newConf</span><span class=p>.</span><span class=na>listLearners</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>oldConf</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>entry</span><span class=p>.</span><span class=na>setOldPeers</span><span class=p>(</span><span class=n>oldConf</span><span class=p>.</span><span class=na>listPeers</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>entry</span><span class=p>.</span><span class=na>setOldLearners</span><span class=p>(</span><span class=n>oldConf</span><span class=p>.</span><span class=na>listLearners</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ConfigurationChangeDone</span><span class=w> </span><span class=n>configurationChangeDone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConfigurationChangeDone</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>currTerm</span><span class=p>,</span><span class=w> </span><span class=n>leaderStart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Use the new_conf to deal the quorum of this very log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>ballotBox</span><span class=p>.</span><span class=na>appendPendingTask</span><span class=p>(</span><span class=n>newConf</span><span class=p>,</span><span class=w> </span><span class=n>oldConf</span><span class=p>,</span><span class=w> </span><span class=n>configurationChangeDone</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Utils</span><span class=p>.</span><span class=na>runClosureInThread</span><span class=p>(</span><span class=n>configurationChangeDone</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=n>RaftError</span><span class=p>.</span><span class=na>EINTERNAL</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Fail to append task.&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>LogEntry</span><span class=o>&gt;</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>entries</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>logManager</span><span class=p>.</span><span class=na>appendEntries</span><span class=p>(</span><span class=n>entries</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LeaderStableClosure</span><span class=p>(</span><span class=n>entries</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>checkAndSetConfiguration</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>但是STAGE_JOINT存在一个隐患，如果Leader没来得及把<code>new&amp;old</code>配置复制到所有Follwer就崩溃了，那么会出现一批只有<code>old</code>和一批<code>new&amp;old</code>的节点，极有可能分别选举出term相同的Leader，一个同时存在于<code>new&amp;old</code>配置的Follwer会收到来自不同Leader的消息。</p><p>之前看到handleAppendEntriesRequest的处理，就是直接<code>currTerm+1</code>强制让两个Leader下台并发起选举，成为新任领导。</p><p>[1] 那么新Leader可以通过日志，向只有<code>old</code>的节点追加<code>new</code>，这样集群配置会长期处在一个unstable状态。发生下次成员变化时，会直接覆盖原来的<code>old</code>，直到步骤走到<code>STAGE_NONE</code>才会恢复到stable状态。</p><p>STAGE_STABLE阶段依然有风险，Leader崩溃后会出现一批只有<code>new</code>和一批<code>new&amp;old</code>的节点，同样会分别出现两个Leader，<code>new</code>和<code>new&amp;old</code>配置中的Follower都有可能收到来自不同Leader的消息。</p><p>同样在handleAppendEntriesRequest做处理，如果<code>new</code>受到，<code>currTerm+1</code>可以使new且删除old的配置复制到其他节点。反之，回带上面[1]的状态。</p><h2 id=2leader转移>2、Leader转移</h2><p>这部分的逻辑更加容易，就不多解释了，可自行阅读源码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=nf>transferLeadershipTo</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>PeerId</span><span class=w> </span><span class=n>peer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Requires</span><span class=p>.</span><span class=na>requireNonNull</span><span class=p>(</span><span class=n>peer</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Null peer&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>writeLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>STATE_LEADER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>STATE_TRANSFERRING</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>RaftError</span><span class=p>.</span><span class=na>EBUSY</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>RaftError</span><span class=p>.</span><span class=na>EPERM</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Not a leader&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>confCtx</span><span class=p>.</span><span class=na>isBusy</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//nope！更改配置过程非常混乱，拒绝转移Leader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=n>RaftError</span><span class=p>.</span><span class=na>EBUSY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Changing the configuration&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PeerId</span><span class=w> </span><span class=n>peerId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>peer</span><span class=p>.</span><span class=na>copy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// if peer_id is ANY_PEER(0.0.0.0:0:0), the peer with the largest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// last_log_id will be selected.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>peerId</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>PeerId</span><span class=p>.</span><span class=na>ANY_PEER</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>peerId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>replicatorGroup</span><span class=p>.</span><span class=na>findTheNextCandidate</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>conf</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Candidate not found for any peer&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>lastLogIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>logManager</span><span class=p>.</span><span class=na>getLastLogIndex</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>replicatorGroup</span><span class=p>.</span><span class=na>transferLeadershipTo</span><span class=p>(</span><span class=n>peerId</span><span class=p>,</span><span class=w> </span><span class=n>lastLogIndex</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=n>RaftError</span><span class=p>.</span><span class=na>EINVAL</span><span class=p>,</span><span class=w> </span><span class=s>&#34;No such peer %s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>STATE_TRANSFERRING</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Status</span><span class=p>(</span><span class=n>RaftError</span><span class=p>.</span><span class=na>ETRANSFERLEADERSHIP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;Raft leader is transferring leadership to %s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>peerId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onLeaderStop</span><span class=p>(</span><span class=n>status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>StopTransferArg</span><span class=w> </span><span class=n>stopArg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StopTransferArg</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>currTerm</span><span class=p>,</span><span class=w> </span><span class=n>peerId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>stopTransferArg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stopArg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>transferTimer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>timerManager</span><span class=p>.</span><span class=na>schedule</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>onTransferTimeout</span><span class=p>(</span><span class=n>stopArg</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>options</span><span class=p>.</span><span class=na>getElectionTimeoutMs</span><span class=p>(),</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=c1>//转移Leader有超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>writeLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>OK</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 1 Leader: replicatorGroup.transferLeadershipTo -&gt; Replicator.transferLeadership</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 2 Follower: com.alipay.sofa.jraft.core.NodeImpl#handleTimeoutNowRequest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 3 Leader: com.alipay.sofa.jraft.core.Replicator#onTimeoutNowReturned</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></article><ul class=article-share><li><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=/jraft%25E6%25BA%2590%25E7%25A0%2581%25E5%2588%2586%25E6%259E%259003%25E6%2588%2590%25E5%2591%2598%25E5%258F%2598%25E5%258C%2596/" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><i class="fa-brands fa-facebook-f"></i></div>Facebook</div></a></li><li><a class=resp-sharing-button__link href="https://x.com/intent/tweet/?text=%e3%80%90JRaft%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%9003%e3%80%91%e6%88%90%e5%91%98%e5%8f%98%e5%8c%96%20-%20%e7%bb%b4%e4%bf%ae%e5%8c%ba%e5%88%b7%e7%b4%ab&amp;url=/jraft%25E6%25BA%2590%25E7%25A0%2581%25E5%2588%2586%25E6%259E%259003%25E6%2588%2590%25E5%2591%2598%25E5%258F%2598%25E5%258C%2596/" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--x resp-sharing-button--medium"><i class="fa-brands fa-x-twitter"></i></div></a></li></ul><ul class="pager article-pager"><li class=pager-newer><a href=/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E5%9C%A8%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8crontab/ data-toggle=tooltip data-placement=top title=【学习记录】在容器中使用crontab>&lt; Newer</a></li><li class=pager-older><a href=/jraft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%9002%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6/ data-toggle=tooltip data-placement=top title=【JRaft源码分析02】心跳机制以及日志复制>Older ></a></li></ul></div><div class=site-footer><div class=copyright>© 2025 黄泽宏 | <a href=https://beian.miit.gov.cn/ target=_blank>粤ICP备2025417888号-1</a></div><ul class=site-footer-items><li class=site-footer-item-about><a href=/about/ title=About>About</a></li></ul><div class=powerdby>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/taikii/whiteplain>Whiteplain</a>
<script>fetch("https://ghtrk-pixel.fly.dev/goodtracker.png?from=hugo-footer-huangzehong_me&ts="+Date.now())</script></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-16F0MHER15"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-16F0MHER15",{anonymize_ip:!1})}</script></body></html>